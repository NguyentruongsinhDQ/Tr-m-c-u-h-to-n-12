import React, { useState, useEffect, useRef, useCallback } from 'react';

/**
 * ·ª®NG D·ª§NG QU·∫¢N L√ù THI ƒê·∫§U ƒê∆Ø·ªúNG L√äN ƒê·ªàNH OLYMPIA
 * T√°c gi·∫£: Nguy·ªÖn Tr∆∞·ªùng Sinh ƒêQ
 * Phi√™n b·∫£n: Pro v7.8 - Fixed Export UI
 * Adapted for Web Preview & Mobile/Tablet/Desktop
 */

// --- PRELOADED DATA (D·ªÆ LI·ªÜU C·ªê ƒê·ªäNH) ---
const PRELOADED_DATA = {
  config: {
    numSets: 4,
    questionsPerSet: 5,
    timePerSet: 120
  },
  generatedSets: [
    {
      "id": 1,
      "name": "B·ªô c√¢u h·ªèi s·ªë 1",
      "questions": [
        {
          "id": "q-9",
          "level": "DEFAULT",
          "question": "T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\sin x - 9$.",
          "answer": "Ta c√≥ $\\int (\\sin x - 9) dx = -\\cos x - 9x + C$"
        },
        {
          "id": "q-0",
          "level": "DEFAULT",
          "question": "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x$.",
          "answer": "Ta c√≥ $\\int \\cos x dx = \\sin x + C$"
        },
        {
          "id": "q-15",
          "level": "DEFAULT",
          "question": "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 2026^x$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int 2026^x dx = \\frac{2026^x}{\\ln 2026} + C$"
        },
        {
          "id": "q-16",
          "level": "DEFAULT",
          "question": "Bi·∫øt r·∫±ng $F(x) = x^3 + e^x$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $f(x)$. T√≠nh gi√° tr·ªã $f(1)$.",
          "answer": "Ta c√≥ $f(x) = F'(x) = 3x^2 + e^x \\Rightarrow f(1) = 3 + e$"
        },
        {
          "id": "q-19",
          "level": "H",
          "question": "[H] T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\tan^2 x + 1$.",
          "answer": "Ta c√≥ $\\int (\\tan^2 x + 1) dx = \\int \\frac{1}{\\cos^2 x} dx = \\tan x + C$"
        }
      ]
    },
    {
      "id": 2,
      "name": "B·ªô c√¢u h·ªèi s·ªë 2",
      "questions": [
        {
          "id": "q-7",
          "level": "DEFAULT",
          "question": "T√¨m nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x - 4x$.",
          "answer": "Ta c√≥ $\\int (\\cos x - 4x) dx = \\sin x - 2x^2 + C$"
        },
        {
          "id": "q-11",
          "level": "DEFAULT",
          "question": "M·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë $y = 10x^4$ l√† h√†m s·ªë n√†o?",
          "answer": "L√† $y = 2x^5 + C$ (V√≠ d·ª•: $2x^5$)"
        },
        {
          "id": "q-10",
          "level": "DEFAULT",
          "question": "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\frac{3}{\\cos^2 x}$ v·ªõi $x \\neq \\frac{\\pi}{2} + k\\pi$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int \\frac{3}{\\cos^2 x} dx = 3\\tan x + C$"
        },
        {
          "id": "q-18",
          "level": "DEFAULT",
          "question": "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = x^3 - x$.",
          "answer": "Ta c√≥ $\\int (x^3 - x) dx = \\frac{x^4}{4} - \\frac{x^2}{2} + C$"
        },
        {
          "id": "q-12",
          "level": "H",
          "question": "[H] Cho $\\int 4^x dx = F(x) + C$. Khi ƒë√≥ h√†m s·ªë ƒë·∫°o h√†m $F'(x)$ b·∫±ng bao nhi√™u?",
          "answer": "Ta c√≥ $F'(x) = f(x) = 4^x$"
        }
      ]
    },
    {
      "id": 3,
      "name": "B·ªô c√¢u h·ªèi s·ªë 3",
      "questions": [
        {
          "id": "q-5",
          "level": "DEFAULT",
          "question": "T√≠nh nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 4\\sin x + 2^x$.",
          "answer": "Ta c√≥ $\\int (4\\sin x + 2^x) dx = -4\\cos x + \\frac{2^x}{\\ln 2} + C$"
        },
        {
          "id": "q-3",
          "level": "DEFAULT",
          "question": "T√¨m t·∫•t c·∫£ nguy√™n h√†m $F(x)$ c·ªßa h√†m s·ªë $f(x) = 2x + \\frac{1}{x}$.",
          "answer": "Ta c√≥ $F(x) = \\int (2x + \\frac{1}{x}) dx = x^2 + \\ln|x| + C$"
        },
        {
          "id": "q-17",
          "level": "H",
          "question": "[H] H√†m s·ªë $F(x) = 2x^3 + 5$ l√† m·ªôt nguy√™n h√†m c·ªßa h√†m s·ªë n√†o?",
          "answer": "Ta c√≥ $f(x) = F'(x) = (2x^3 + 5)' = 6x^2$"
        },
        {
          "id": "q-6",
          "level": "DEFAULT",
          "question": "M·ªánh ƒë·ªÅ $\\int k \\cdot f(x) dx = k \\int f(x) dx$ (v·ªõi $k$ l√† h·∫±ng s·ªë kh√°c 0) l√† ƒë√∫ng hay sai?",
          "answer": "ƒê√∫ng (T√≠nh ch·∫•t c∆° b·∫£n c·ªßa nguy√™n h√†m)."
        },
        {
          "id": "q-1",
          "level": "DEFAULT",
          "question": "Nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 5^x$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int 5^x dx = \\frac{5^x}{\\ln 5} + C$"
        }
      ]
    },
    {
      "id": 4,
      "name": "B·ªô c√¢u h·ªèi s·ªë 4",
      "questions": [
        {
          "id": "q-4",
          "level": "DEFAULT",
          "question": "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = 2e^x + 5$ tr√™n $\\mathbb{R}$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int (2e^x + 5) dx = 2e^x + 5x + C$"
        },
        {
          "id": "q-13",
          "level": "H",
          "question": "[H] Cho $\\int (3x^2 - 1) dx = F(x) + C$. Khi ƒë√≥ $F'(x)$ b·∫±ng bao nhi√™u?",
          "answer": "Ta c√≥ $F'(x) = 3x^2 - 1$"
        },
        {
          "id": "q-8",
          "level": "DEFAULT",
          "question": "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = e^x - \\sin x$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int (e^x - \\sin x) dx = e^x + \\cos x + C$"
        },
        {
          "id": "q-2",
          "level": "DEFAULT",
          "question": "T√¨m h·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = \\cos x - \\frac{1}{\\sin^2 x}$.",
          "answer": "Ta c√≥ $\\int (\\cos x - \\frac{1}{\\sin^2 x}) dx = \\sin x + \\cot x + C$"
        },
        {
          "id": "q-14",
          "level": "DEFAULT",
          "question": "H·ªç nguy√™n h√†m c·ªßa h√†m s·ªë $f(x) = x^{2023}$ l√† g√¨?",
          "answer": "Ta c√≥ $\\int x^{2023} dx = \\frac{1}{2024}x^{2024} + C$"
        }
      ]
    }
  ]
};

// --- 0. INTERNAL ICONS ---
const Icon = ({ path, ...props }) => (
  <svg 
    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" 
    fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" 
    {...props}
  >
    {path}
  </svg>
);

const Upload = (props) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} {...props} />;
const Play = (props) => <Icon path={<polygon points="5 3 19 12 5 21 5 3"/>} {...props} />;
const Pause = (props) => <Icon path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} {...props} />;
const RotateCcw = (props) => <Icon path={<><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></>} {...props} />;
const CheckCircle = (props) => <Icon path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} {...props} />;
const XCircle = (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} {...props} />;
const Eye = (props) => <Icon path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} {...props} />;
const EyeOff = (props) => <Icon path={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>} {...props} />;
const Star = (props) => <Icon path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} {...props} />;
const Calculator = (props) => <Icon path={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></>} {...props} />;
const FileText = (props) => <Icon path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} {...props} />;
const Settings = (props) => <Icon path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} {...props} />;
const ChevronRight = (props) => <Icon path={<polyline points="9 18 15 12 9 6"/>} {...props} />;
const Trophy = (props) => <Icon path={<><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4h10"/><path d="M17 4v3a5 5 0 0 1-10 0V4"/><line x1="8" y1="4" x2="8" y2="4"/><line x1="16" y1="4" x2="16" y2="4"/></>} {...props} />;
const AlertCircle = (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} {...props} />;
const Edit3 = (props) => <Icon path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></>} {...props} />;
const Save = (props) => <Icon path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} {...props} />;
const AlertTriangle = (props) => <Icon path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} {...props} />;
const Home = (props) => <Icon path={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} {...props} />;
const SkipForward = (props) => <Icon path={<><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></>} {...props} />;
const ArrowRight = (props) => <Icon path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} {...props} />;
const Clock = (props) => <Icon path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} {...props} />;
const RefreshCw = (props) => <Icon path={<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} {...props} />;
const MonitorPlay = (props) => <Icon path={<><path d="M5 3l14 9-14 9V3z"/><rect x="2" y="3" width="20" height="14" rx="2" ry="2" transform="matrix(1 0 0 1 0 0)" style={{opacity: 0}} /><path d="M12 17v4"/><path d="M8 21h8"/><rect x="2" y="3" width="20" height="14" rx="2" ry="2" fill="none" /></>} {...props} />;
const ArrowLeft = (props) => <Icon path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} {...props} />;
const FolderOpen = (props) => <Icon path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></>} {...props} />;
const Trash2 = (props) => <Icon path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} {...props} />;
const Download = (props) => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} {...props} />;
const FileJson = (props) => <Icon path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M10 12h4"/><path d="M10 16h4"/></>} {...props} />;
const FileCode = (props) => <Icon path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><polyline points="10 13 8 15 10 17"/><polyline points="14 13 16 15 14 17"/></>} {...props} />;
const ArrowLeftRight = (props) => <Icon path={<><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/></>} {...props} />;
const Share2 = (props) => <Icon path={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></>} {...props} />;

// --- 1. CONFIG & UTILS ---

const useExternalScripts = () => {
  const [loaded, setLoaded] = useState(false);

  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement("script");
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };

    const loadStyle = (href) => {
      if (!document.querySelector(`link[href="${href}"]`)) {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = href;
        document.head.appendChild(link);
      }
    };

    const init = async () => {
      try {
        loadStyle("https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css");
        await loadScript("https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js");
        await Promise.all([
          loadScript("https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"),
          loadScript("https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"),
          loadScript("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js")
        ]);
        window.pdfjsWorkerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        setLoaded(true);
      } catch (e) {
        console.error("L·ªói t·∫£i th∆∞ vi·ªán:", e);
      }
    };

    init();
  }, []);

  return loaded;
};

const LatexContent = ({ content, className = "" }) => {
  const containerRef = useRef(null);

  useEffect(() => {
    if (window.renderMathInElement && window.katex && containerRef.current) {
      try {
        window.renderMathInElement(containerRef.current, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\(", right: "\\)", display: false },
            { left: "\\[", right: "\\]", display: true }
          ],
          throwOnError: false,
          output: 'html' 
        });
      } catch (e) {
        console.error("KaTeX render error:", e);
      }
    }
  }, [content]);

  const safeContent = typeof content === 'string' ? content : String(content || '');

  return (
    <div 
      ref={containerRef} 
      className={`font-sans leading-loose whitespace-pre-line ${className}`}
      dangerouslySetInnerHTML={{ __html: safeContent }} 
    />
  );
};

const Modal = ({ isOpen, title, message, type = 'info', onClose, children }) => {
  if (!isOpen) return null;
  const colors = {
    info: 'bg-blue-600',
    error: 'bg-red-600',
    success: 'bg-green-600',
    warning: 'bg-yellow-600',
    edit: 'bg-slate-700'
  };
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-in fade-in duration-200 p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 max-h-[90vh] flex flex-col">
        <div className={`${colors[type] || colors.info} p-4 flex items-center justify-between shrink-0`}>
          <h3 className="text-white font-bold text-lg flex items-center gap-2">
            {type === 'error' && <AlertCircle size={20}/>}
            {type === 'success' && <Trophy size={20}/>}
            {type === 'warning' && <AlertTriangle size={20}/>}
            {type === 'edit' && <Edit3 size={20}/>}
            {title}
          </h3>
          <button onClick={onClose} className="text-white/80 hover:text-white">
            <XCircle size={24} />
          </button>
        </div>
        <div className="p-6 overflow-y-auto">
          {children ? children : <p className="text-gray-700 text-lg">{message}</p>}
        </div>
        {!children && (
            <div className="p-4 bg-gray-50 flex justify-end shrink-0">
            <button 
                onClick={onClose}
                className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition font-medium"
            >
                ƒê√≥ng
            </button>
            </div>
        )}
      </div>
    </div>
  );
};

// --- 2. MAIN APP COMPONENT ---

export default function App() {
  const libsLoaded = useExternalScripts();
  
  // Changed initial state to 'selection' to start immediately with preloaded data
  const [view, setView] = useState('selection'); // input, dashboard, selection, game
  const [modal, setModal] = useState({ open: false, title: '', message: '', type: 'info' });
  const [rawInput, setRawInput] = useState("");
  const [parseErrors, setParseErrors] = useState([]); 
  
  // Save/Load & Swap State
  const [hasSavedData, setHasSavedData] = useState(false);
  const [swapMode, setSwapMode] = useState(false);
  const [swapSource, setSwapSource] = useState(null); 

  // Edit & Management State
  const [editingQ, setEditingQ] = useState(null); 
  const [playedSetIndices, setPlayedSetIndices] = useState([]); 
  
  // Initialize with PRELOADED_DATA
  const [config, setConfig] = useState(PRELOADED_DATA.config);
  
  const [generatedSets, setGeneratedSets] = useState(PRELOADED_DATA.generatedSets);
  const [currentSetIndex, setCurrentSetIndex] = useState(0);
  
  const [gameState, setGameState] = useState({
    currentQIndex: 0,
    score: 0,
    isPlaying: false,
    timeLeft: 60,
    isStar: false,
    showAnswer: false,
    helpQueue: [],
    isHelpRound: false,
    finished: false,
    roundEnded: false, 
    questions: []
  });

  const timerRef = useRef(null);

  // --- AUTO LOAD DATA ON STARTUP ---
  useEffect(() => {
    const savedData = localStorage.getItem('olympia_app_data');
    if (savedData) {
      setHasSavedData(true);
      // We don't automatically overwrite PRELOADED_DATA on first load to ensure
      // the user sees the hardcoded "NGUY√äN H√ÄM" content by default if they want "new session".
      // But we still offer the option to load old data in the 'Input' screen.
    }
  }, []);

  // --- LOGIC X·ª¨ L√ù D·ªÆ LI·ªÜU ---

  const showModal = (title, message, type = 'info') => {
    setModal({ open: true, title, message, type });
  };

  const saveToLocalStorage = (data) => {
      try {
          localStorage.setItem('olympia_app_data', JSON.stringify(data));
          setHasSavedData(true);
      } catch (e) {
          console.error("L·ªói auto-save:", e);
      }
  }

  const handleSaveData = () => {
    const dataToSave = {
      config,
      generatedSets,
      playedSetIndices,
      timestamp: new Date().toLocaleString()
    };
    saveToLocalStorage(dataToSave);
    showModal("L∆∞u th√†nh c√¥ng", "B·ªô ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát.", "success");
  };

  const handleExportData = () => {
    const dataToSave = {
      config,
      generatedSets,
      playedSetIndices,
      timestamp: new Date().toLocaleString()
    };
    const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `olympia_data_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showModal("Xu·∫•t file JSON th√†nh c√¥ng", "File d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.", "success");
  };

  const handleLoadData = () => {
    try {
      const savedJson = localStorage.getItem('olympia_app_data');
      if (savedJson) {
        const parsed = JSON.parse(savedJson);
        setConfig(parsed.config);
        setGeneratedSets(parsed.generatedSets);
        setPlayedSetIndices(parsed.playedSetIndices || []);
        setView('dashboard'); 
        showModal("T·∫£i th√†nh c√¥ng", `ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu l∆∞u l√∫c: ${parsed.timestamp}`, "success");
      }
    } catch (e) {
      showModal("L·ªói t·∫£i d·ªØ li·ªáu", "D·ªØ li·ªáu l∆∞u tr·ªØ b·ªã h·ªèng.", "error");
    }
  };

  const handleClearData = () => {
    if (confirm("X√≥a d·ªØ li·ªáu ƒë√£ l∆∞u trong tr√¨nh duy·ªát? \n\nD·ªØ li·ªáu s·∫Ω tr·ªü v·ªÅ b·ªô m·∫∑c ƒë·ªãnh (NGUY√äN H√ÄM).")) {
        localStorage.removeItem('olympia_app_data');
        setHasSavedData(false);
        // Reset to default
        setConfig(PRELOADED_DATA.config);
        setGeneratedSets(PRELOADED_DATA.generatedSets);
        setPlayedSetIndices([]);
        setView('selection');
    }
  };

  // --- T·∫†O FILE HTML C√ì TH·ªÇ CH∆†I ƒê∆Ø·ª¢C (PLAYABLE HTML) ---
  const handleExportPlayableHTML = () => {
    const gameData = {
      generatedSets,
      config,
      timestamp: new Date().toLocaleString()
    };

    const gameScript = `
      const gameData = ${JSON.stringify(gameData)};
      let currentSetIndex = 0;
      let questions = [];
      let currentQIndex = 0;
      let score = 0;
      let timeLeft = gameData.config.timePerSet;
      let timerInterval = null;
      let isPlaying = false;
      let isStar = false;
      let showAnswer = false;
      let helpQueue = [];
      let isHelpRound = false;
      let playedIndices = JSON.parse(localStorage.getItem('olympia_played_indices') || '[]');
      
      const app = document.getElementById('app');

      window.handleSaveState = function() {
        localStorage.setItem('olympia_played_indices', JSON.stringify(playedIndices));
        alert('ƒê√£ l∆∞u tr·∫°ng th√°i c√°c g√≥i c√¢u h·ªèi ƒë√£ ch∆°i v√†o tr√¨nh duy·ªát!');
      }

      window.handleResetState = function() {
        if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô tr·∫°ng th√°i ƒë√£ ch∆°i?')) {
            playedIndices = [];
            localStorage.removeItem('olympia_played_indices');
            renderSelection();
        }
      }

      function renderMath() {
        if(window.renderMathInElement) {
          renderMathInElement(document.body, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false}
            ],
            throwOnError: false
          });
        }
      }

      function renderSelection() {
        clearInterval(timerInterval);
        app.innerHTML = \`
          <div class="min-h-screen bg-gradient-to-br from-blue-900 to-slate-900 p-4 md:p-8 font-sans flex flex-col">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 md:mb-12 gap-4">
              <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-4xl font-bold text-white uppercase tracking-widest drop-shadow-md">V√íNG 1-KH·ªûI ƒê·ªòNG C√ôNG ƒê·ªíNG ƒê·ªòI</h1>
                <p class="text-blue-300 mt-2 text-sm md:text-base">D·ªØ li·ªáu xu·∫•t l√∫c: \${gameData.timestamp}</p>
              </div>
              <div class="flex flex-wrap gap-2 md:gap-4 justify-center">
                 <button onclick="handleSaveState()" class="text-blue-200 hover:text-white hover:bg-blue-700 font-medium px-3 py-2 md:px-4 rounded-md flex items-center gap-1 md:gap-2 transition text-xs md:text-sm border border-blue-700/50" title="L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> <span class="hidden sm:inline">L∆∞u</span>
                 </button>
                 <button onclick="handleResetState()" class="text-orange-400 hover:text-orange-300 font-medium flex items-center gap-1 px-3 py-2 md:px-4 border border-orange-400/50 rounded-lg bg-orange-900/20 text-xs md:text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> <span class="hidden sm:inline">Reset</span>
                 </button>
              </div>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8">
              \${gameData.generatedSets.map((set, idx) => {
                const isPlayed = playedIndices.includes(idx);
                return \`
                <button \${isPlayed ? 'disabled' : ''} onclick="startGame(\${idx})" class="group relative h-48 md:h-64 rounded-2xl flex flex-col items-center justify-center border-2 transition-all duration-300 transform \${isPlayed ? 'bg-slate-800/50 border-slate-700 opacity-50 cursor-not-allowed scale-95' : 'bg-white/10 border-blue-400/50 hover:bg-blue-600 hover:border-blue-400 hover:scale-105 hover:shadow-[0_0_40px_rgba(37,99,235,0.6)] cursor-pointer'}">
                  <div class="p-4 md:p-6 rounded-full mb-2 md:mb-4 transition-colors \${isPlayed ? 'bg-slate-700 text-slate-500' : 'bg-white text-blue-900 group-hover:scale-110'}">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\${isPlayed ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>'}</svg>
                  </div>
                  <h2 class="text-xl md:text-2xl font-bold uppercase tracking-wider \${isPlayed ? 'text-slate-500' : 'text-white'}">\${set.name}</h2>
                  <span class="text-blue-200 text-xs md:text-sm mt-1 md:mt-2">\${set.questions.length} c√¢u</span>
                  \${isPlayed ? '<span class="absolute top-2 right-2 md:top-4 md:right-4 text-green-500 font-bold text-xs border border-green-500 px-2 py-1 rounded">ƒê√É CH∆†I</span>' : ''}
                </button>
              \`}).join('')}
            </div>
          </div>
        \`;
      }

      window.startGame = function(idx) {
        currentSetIndex = idx;
        questions = gameData.generatedSets[idx].questions;
        if(!playedIndices.includes(idx)) playedIndices.push(idx);
        currentQIndex = 0;
        score = 0;
        timeLeft = Number(gameData.config.timePerSet);
        isStar = false;
        showAnswer = false;
        helpQueue = [];
        isHelpRound = false;
        
        isPlaying = true;
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
              timeLeft--;
              renderGame();
            } else {
              clearInterval(timerInterval);
              isPlaying = false;
              renderGame();
            }
        }, 1000);

        renderGame();
      }

      function renderGame() {
        if(currentQIndex >= questions.length && !isHelpRound) {
            renderEndOfMainRound();
            return;
        }
        if(isHelpRound && currentQIndex >= questions.length) {
            renderFinished();
            return;
        }

        const q = questions[currentQIndex];
        const radius = 40;
        const circumference = 2 * Math.PI * radius;
        const totalTime = Number(gameData.config.timePerSet);
        const offset = circumference - (timeLeft / totalTime) * circumference;

        app.innerHTML = \`
          <div class="min-h-screen bg-[#0f172a] text-white overflow-hidden relative font-sans flex flex-col">
            <header class="relative z-10 flex flex-col md:flex-row items-center justify-between px-4 md:px-6 py-4 bg-white/5 border-b border-white/10 backdrop-blur-md gap-4">
              <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto justify-between md:justify-start">
                <div class="bg-blue-600 px-3 md:px-4 py-1 rounded text-xs md:text-sm font-bold shadow-lg truncate max-w-[150px] md:max-w-none">\${gameData.generatedSets[currentSetIndex].name}</div>
                <div class="px-3 md:px-4 py-1 rounded text-xs md:text-sm font-bold shadow-lg \${isHelpRound ? 'bg-red-600 animate-pulse' : 'bg-slate-700'}">\${isHelpRound ? 'V√íNG TR·ª¢ GI√öP' : 'V√íNG CH√çNH'}</div>
              </div>
              <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                <div class="flex items-center gap-2 md:gap-4 bg-black/20 px-4 md:px-5 py-2 rounded-2xl border border-white/5">
                  <span className="text-xs md:text-sm font-bold text-slate-300 uppercase tracking-wider">T·ªïng ƒëi·ªÉm</span>
                  <span class="text-3xl md:text-5xl font-bold text-yellow-400 font-mono leading-none drop-shadow-[0_2px_10px_rgba(250,204,21,0.5)]">\${score}</span>
                </div>
                <button onclick="renderSelection()" class="px-3 md:px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs md:text-sm font-bold border border-slate-500 whitespace-nowrap">üè† V·ªÅ Menu</button>
              </div>
            </header>

            <main class="relative z-10 flex-1 flex flex-col items-center justify-center p-4 md:p-6 w-full max-w-7xl mx-auto">
               <div class="w-full bg-white/10 border border-white/20 rounded-3xl p-6 md:p-12 backdrop-blur-md shadow-2xl relative min-h-[300px] md:min-h-[400px] flex flex-col justify-center">
                  <div class="absolute top-4 left-4 md:top-6 md:left-8 flex flex-wrap items-center gap-2 md:gap-3">
                    <span class="bg-slate-800 text-slate-300 px-3 py-1 rounded-full text-xs md:text-sm font-bold border border-slate-600">C√¢u \${currentQIndex + 1} / \${questions.length}</span>
                    \${isStar ? '<span class="bg-yellow-500 text-black px-3 py-1 rounded-full text-xs md:text-sm font-bold flex items-center gap-1 animate-pulse shadow-yellow-500/50 shadow-lg">‚≠ê NG√îI SAO HY V·ªåNG</span>' : ''}
                  </div>
                  <div class="text-center space-y-4 md:space-y-8 mt-8 md:mt-6">
                    <div class="text-xl sm:text-2xl md:text-4xl lg:text-5xl font-bold leading-tight drop-shadow-md text-white whitespace-pre-line font-sans leading-loose">\${q.question}</div>
                    <div class="transition-all duration-300 overflow-hidden \${showAnswer ? 'max-h-80 opacity-100 mt-4 md:mt-8' : 'max-h-0 opacity-0'}">
                        <div class="inline-block bg-green-600/90 text-white px-4 md:px-8 py-2 md:py-4 rounded-xl text-lg md:text-2xl font-bold shadow-lg border border-green-400/50 font-sans leading-loose">\${q.answer}</div>
                    </div>
                  </div>
               </div>

               <div class="w-full mt-6 md:mt-8 flex flex-col lg:flex-row items-center justify-between gap-6">
                  <div class="flex items-center gap-4">
                    <div class="relative w-16 h-16 md:w-24 md:h-24 shrink-0">
                        <svg class="w-full h-full transform -rotate-90">
                          <circle cx="50%" cy="50%" r="45%" stroke="#334155" stroke-width="6" fill="transparent" />
                          <circle cx="50%" cy="50%" r="45%" stroke="\${timeLeft < 10 ? '#ef4444' : '#3b82f6'}" stroke-width="6" fill="transparent" stroke-dasharray="\${circumference}" stroke-dashoffset="\${offset}" class="transition-all duration-1000" />
                        </svg>
                        <span class="absolute inset-0 flex items-center justify-center text-lg md:text-2xl font-bold font-mono">\${timeLeft}s</span>
                    </div>
                    <button onclick="toggleTimer()" class="p-3 md:p-4 bg-slate-700 rounded-full hover:bg-slate-600 shadow-lg">\${isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                    <button onclick="resetTimer()" class="p-3 md:p-4 bg-slate-700 rounded-full hover:bg-slate-600 shadow-lg">üîÑ</button>
                  </div>

                  <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 w-full lg:w-auto">
                    \${!showAnswer ? \`
                      \${!isHelpRound ? \`<button onclick="toggleStar()" class="px-4 py-3 md:px-6 md:py-4 rounded-xl text-sm md:text-base font-bold flex items-center gap-2 border \${isStar ? 'bg-yellow-500 text-black border-yellow-400' : 'bg-slate-800 text-slate-400 border-slate-700'}">‚≠ê Ng√¥i Sao</button>\` : ''}
                      <button onclick="handleSkip()" class="px-4 py-3 md:px-6 md:py-4 bg-slate-700 text-slate-200 border border-slate-600 rounded-xl text-sm md:text-base font-bold hover:bg-red-900/50">‚è≠Ô∏è B·ªè qua</button>
                      <button onclick="revealAnswer()" class="px-4 py-3 md:px-6 md:py-4 bg-blue-600 text-white rounded-xl text-sm md:text-base font-bold hover:bg-blue-500 shadow-lg">üëÅÔ∏è Hi·ªán ƒë√°p √°n</button>
                    \` : \`
                      <button onclick="handleGrade(false)" class="px-6 py-3 md:px-8 md:py-4 bg-red-600/20 text-red-400 border border-red-600/50 rounded-xl text-sm md:text-base font-bold hover:bg-red-600 hover:text-white">‚ùå SAI</button>
                      <button onclick="handleGrade(true)" class="px-6 py-3 md:px-8 md:py-4 bg-green-600 text-white rounded-xl text-sm md:text-base font-bold hover:bg-green-500 shadow-lg">‚úÖ ƒê√öNG</button>
                    \`}
                  </div>
               </div>
            </main>
          </div>
        \`;
        renderMath();
      }

      window.toggleTimer = function() {
        if(isPlaying) {
          clearInterval(timerInterval);
          isPlaying = false;
        } else {
          isPlaying = true;
          timerInterval = setInterval(() => {
            if(timeLeft > 0) {
              timeLeft--;
              renderGame();
            } else {
              clearInterval(timerInterval);
              isPlaying = false;
              renderGame();
            }
          }, 1000);
        }
        renderGame();
      }

      window.resetTimer = function() {
        timeLeft = Number(gameData.config.timePerSet);
        renderGame();
      }

      window.toggleStar = function() {
        isStar = !isStar;
        renderGame();
      }

      window.revealAnswer = function() {
        showAnswer = true;
        clearInterval(timerInterval);
        isPlaying = false;
        renderGame();
      }

      window.handleSkip = function() {
        let change = 0;
        if(isStar && !isHelpRound) change = -5;
        score += change;
        if(!isHelpRound) helpQueue.push(questions[currentQIndex]);
        nextQuestion();
      }

      window.handleGrade = function(correct) {
        let change = 0;
        if(correct) {
            if(isHelpRound) change = 2.5;
            else change = isStar ? 10 : 5;
        } else {
            if(!isHelpRound) {
              change = isStar ? -5 : 0;
              helpQueue.push(questions[currentQIndex]);
            }
        }
        score += change;
        nextQuestion();
      }

      function nextQuestion() {
        currentQIndex++;
        isStar = false;
        showAnswer = false;
        isPlaying = true;
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
              timeLeft--;
              renderGame();
            } else {
              clearInterval(timerInterval);
              isPlaying = false;
              renderGame();
            }
        }, 1000);
        renderGame();
      }

      function renderEndOfMainRound() {
        if(helpQueue.length > 0) {
            app.innerHTML = \`
              <div class="min-h-screen bg-slate-900 flex items-center justify-center text-white text-center p-8">
                <div>
                  <h1 class="text-3xl md:text-5xl font-bold text-orange-500 mb-6">‚ö†Ô∏è K·∫æT TH√öC V√íNG CH√çNH</h1>
                  <p class="text-xl md:text-2xl mb-8">C√≥ <strong>\${helpQueue.length}</strong> c√¢u h·ªèi trong h√†ng ƒë·ª£i tr·ª£ gi√∫p.</p>
                  <button onclick="startHelpRound()" class="px-8 py-3 md:px-10 md:py-4 bg-purple-600 hover:bg-purple-500 rounded-full text-lg md:text-xl font-bold shadow-lg animate-pulse">
                    üïí B·∫ÆT ƒê·∫¶U V√íNG TR·ª¢ GI√öP
                  </button>
                </div>
              </div>
            \`;
        } else {
            renderFinished();
        }
      }

      window.startHelpRound = function() {
        isHelpRound = true;
        questions = helpQueue;
        currentQIndex = 0;
        isStar = false;
        showAnswer = false;
        isPlaying = false;
        renderGame();
      }

      function renderFinished() {
        app.innerHTML = \`
              <div class="min-h-screen bg-slate-900 flex items-center justify-center text-white text-center p-8">
                <div>
                  <h1 class="text-4xl md:text-6xl font-bold text-yellow-400 mb-6">üèÜ HO√ÄN TH√ÄNH</h1>
                  <p class="text-2xl md:text-3xl mb-8">T·ªïng ƒëi·ªÉm: <strong class="text-yellow-300">\${score}</strong></p>
                  <button onclick="renderSelection()" class="px-6 py-3 md:px-8 md:py-3 bg-white text-slate-900 rounded-full text-base md:text-lg font-bold hover:bg-blue-50">V·ªÅ Menu Ch√≠nh</button>
                </div>
              </div>
        \`;
      }

      renderSelection();
    `;

    const htmlContent = `<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Olympia Game Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; } 
    .katex { font-size: 1.1em; }
    @media (max-width: 640px) { .katex { font-size: 1em; } }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    ${gameScript}
  </script>
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Olympia_Game_${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showModal("Xu·∫•t Game Th√†nh C√¥ng", "File game tr·ªçn g√≥i ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng! \n\nB·∫°n c√≥ th·ªÉ g·ª≠i file .html n√†y qua Zalo/Email cho ng∆∞·ªùi kh√°c. H·ªç ch·ªâ c·∫ßn m·ªü file b·∫±ng tr√¨nh duy·ªát (Chrome/C·ªëc C·ªëc) l√† c√≥ th·ªÉ ch∆°i ngay l·∫≠p t·ª©c m√† kh√¥ng c·∫ßn nh·∫≠p li·ªáu l·∫°i.", "success");
  };

  const handleImportFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const parsed = JSON.parse(e.target.result);
            if (parsed.generatedSets && parsed.config) {
                setConfig(parsed.config);
                setGeneratedSets(parsed.generatedSets);
                setPlayedSetIndices(parsed.playedSetIndices || []);
                setView('dashboard');
                showModal("Nh·∫≠p file th√†nh c√¥ng", `ƒê√£ t·∫£i b·ªô ƒë·ªÅ t·ª´ file: ${file.name}`, "success");
                saveToLocalStorage({
                    config: parsed.config,
                    generatedSets: parsed.generatedSets,
                    playedSetIndices: parsed.playedSetIndices || [],
                    timestamp: new Date().toLocaleString()
                });
            } else {
                showModal("L·ªói ƒë·ªãnh d·∫°ng", "File kh√¥ng h·ª£p l·ªá.", "error");
            }
        } catch (err) {
            showModal("L·ªói ƒë·ªçc file", "Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung file.", "error");
        }
    };
    reader.readAsText(file);
  };

  // --- LOGIC PARSE & UPLOAD (INPUT) ---

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      if (file.type === "text/plain") {
        const text = await file.text();
        setRawInput(text);
      } else if (file.name.endsWith(".docx")) {
        if (!window.mammoth) throw new Error("Th∆∞ vi·ªán Mammoth ch∆∞a t·∫£i xong.");
        const arrayBuffer = await file.arrayBuffer();
        const result = await window.mammoth.extractRawText({ arrayBuffer });
        setRawInput(result.value);
      } else if (file.type === "application/pdf") {
        if (!window.pdfjsLib) throw new Error("Th∆∞ vi·ªán PDF.js ch∆∞a t·∫£i xong.");
        const arrayBuffer = await file.arrayBuffer();
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = window.pdfjsWorkerSrc;
        const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(" ");
          fullText += pageText + "\n";
        }
        setRawInput(fullText);
      } else {
        showModal("L·ªói ƒë·ªãnh d·∫°ng", "Ch·ªâ h·ªó tr·ª£ file .txt, .docx, v√† .pdf", "error");
      }
    } catch (err) {
      console.error(err);
      showModal("L·ªói ƒë·ªçc file", "Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung file. Vui l√≤ng ki·ªÉm tra l·∫°i.", "error");
    }
  };

  const parseData = () => {
    if (!rawInput.trim()) {
      showModal("D·ªØ li·ªáu tr·ªëng", "Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c t·∫£i file.", "warning");
      return;
    }

    if (!config.numSets || !config.questionsPerSet) {
        showModal("C·∫•u h√¨nh kh√¥ng h·ª£p l·ªá", "Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng b·ªô ƒë·ªÅ v√† c√¢u h·ªèi l·ªõn h∆°n 0.", "error");
        return;
    }

    const lines = rawInput.split(/\r?\n/);
    const questions = [];
    const errors = [];
    
    const startPattern = /^(C√¢u|B√†i|Question)\s*\d+|^\d+[\.\:\)]/i;
    let currentBlock = null;

    lines.forEach((line, idx) => {
      const trimmed = line.trim();
      if (!trimmed) return;

      if (startPattern.test(trimmed)) {
        if (currentBlock) processBlock(currentBlock, questions, errors);
        currentBlock = { text: trimmed, startLine: idx + 1 };
      } else {
        if (currentBlock) {
          currentBlock.text += " " + trimmed;
        } else {
          if (trimmed.includes('|')) {
             currentBlock = { text: trimmed, startLine: idx + 1 };
          }
        }
      }
    });
    if (currentBlock) processBlock(currentBlock, questions, errors);

    setParseErrors(errors);

    // Check quantity
    if (questions.length === 0) {
      showModal("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu", "Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c c√¢u h·ªèi n√†o.", "error");
      return;
    }

    const totalRequired = parseInt(config.numSets) * parseInt(config.questionsPerSet);
    if (questions.length < totalRequired) {
      showModal(
        "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ngu·ªìn", 
        `C·∫•u h√¨nh y√™u c·∫ßu t·ªïng c·ªông ${totalRequired} c√¢u h·ªèi (${config.numSets} b·ªô x ${config.questionsPerSet} c√¢u/b·ªô), nh∆∞ng d·ªØ li·ªáu ngu·ªìn ch·ªâ t√¨m th·∫•y ${questions.length} c√¢u. Vui l√≤ng b·ªï sung th√™m c√¢u h·ªèi ho·∫∑c gi·∫£m c·∫•u h√¨nh.`, 
        "error"
      );
      return;
    }

    if (questions.length > 0) distributeSetsBalanced(questions);
  };

  const processBlock = (block, list, errors) => {
    let parts = block.text.split(' | ');
    if (parts.length < 2) parts = block.text.split('|');

    if (parts.length < 2) {
        errors.push({ line: block.startLine, msg: "Thi·∫øu d·∫•u ngƒÉn c√°ch '|' gi·ªØa c√¢u h·ªèi v√† ƒë√°p √°n." });
        return;
    }

    const questionText = parts[0].trim();
    const answerText = parts.slice(1).join('|').trim();
    const cleanQuestion = questionText.replace(/^(C√¢u|B√†i|Question)?\s*\d+[\.\:\)]?\s*/i, '');

    // DETECT LEVEL
    // Regex t√¨m ki·∫øm m·∫´u (H), [H], (NB), [VD]... ngay ƒë·∫ßu c√¢u ho·∫∑c sau s·ªë th·ª© t·ª±
    const levelMatch = block.text.match(/^(?:C√¢u|B√†i|Question)?\s*\d+[\.\:\)]?\s*[\(\[\{]([^\)\]\}]+)[\)\]\}]/i);
    const level = levelMatch ? levelMatch[1].trim().toUpperCase() : 'DEFAULT';

    list.push({
        id: `q-${list.length}`,
        level: level,
        question: cleanQuestion || questionText,
        answer: answerText
    });
  };

  // --- NEW: BALANCED DISTRIBUTION LOGIC ---
  const distributeSetsBalanced = (allQuestions) => {
    setPlayedSetIndices([]);
    const numSets = Number(config.numSets) || 4;
    const qPerSet = Number(config.questionsPerSet) || 10;

    const sets = Array.from({ length: numSets }, (_, i) => ({
        id: i + 1,
        name: `B·ªô c√¢u h·ªèi s·ªë ${i + 1}`,
        questions: []
    }));

    // Group questions by detected level
    const groups = {};
    allQuestions.forEach(q => {
        if (!groups[q.level]) groups[q.level] = [];
        groups[q.level].push(q);
    });

    // Distribute each group round-robin
    Object.keys(groups).sort().forEach(level => {
        const questionsInLevel = groups[level];
        // Shuffle within level for randomness
        questionsInLevel.sort(() => 0.5 - Math.random());
        
        questionsInLevel.forEach((q, i) => {
            const setIndex = i % numSets;
            if (sets[setIndex].questions.length < qPerSet) {
               sets[setIndex].questions.push(q);
            }
        });
    });

    // 2. MIX QUESTIONS INSIDE EACH SET
    sets.forEach(set => {
        set.questions.sort(() => 0.5 - Math.random());
    });

    setGeneratedSets(sets);
    if (parseErrors.length < allQuestions.length) setView('dashboard');
  };

  // --- LOGIC SWAP (HO√ÅN ƒê·ªîI) ---
  const handleSwapSelect = (setIdx, qIdx) => {
    if (!swapMode) return; // N·∫øu ch∆∞a b·∫≠t ch·∫ø ƒë·ªô th√¨ kh√¥ng l√†m g√¨

    if (!swapSource) {
      // Ch·ªçn ngu·ªìn (l·∫ßn click 1)
      setSwapSource({ setIdx, qIdx });
    } else {
      // Ch·ªçn ƒë√≠ch (l·∫ßn click 2) -> th·ª±c hi·ªán ho√°n ƒë·ªïi
      const newSets = [...generatedSets];
      
      const sourceQ = newSets[swapSource.setIdx].questions[swapSource.qIdx];
      const targetQ = newSets[setIdx].questions[qIdx];

      // Swap elements
      newSets[swapSource.setIdx].questions[swapSource.qIdx] = targetQ;
      newSets[setIdx].questions[qIdx] = sourceQ;

      setGeneratedSets(newSets);
      setSwapSource(null); // Reset selection
      
      // Auto Save
      saveToLocalStorage({
          config,
          generatedSets: newSets,
          playedSetIndices,
          timestamp: new Date().toLocaleString()
      });
    }
  };

  // --- LOGIC CH·ªàNH S·ª¨A ---
  const handleEditClick = (setIdx, qIdx, question) => {
    setEditingQ({
      setIdx,
      qIdx,
      question: question.question,
      answer: question.answer
    });
  };

  const saveEditedQuestion = () => {
    if (!editingQ) return;
    const newSets = [...generatedSets];
    newSets[editingQ.setIdx].questions[editingQ.qIdx] = {
      ...newSets[editingQ.setIdx].questions[editingQ.qIdx],
      question: editingQ.question,
      answer: editingQ.answer
    };
    setGeneratedSets(newSets);
    setEditingQ(null);
    saveToLocalStorage({
        config,
        generatedSets: newSets,
        playedSetIndices,
        timestamp: new Date().toLocaleString()
    });
  };

  // --- LOGIC GAMEPLAY ---

  const initGame = (setIndex) => {
    setCurrentSetIndex(setIndex);
    const newPlayedIndices = [...playedSetIndices, setIndex];
    setPlayedSetIndices(newPlayedIndices);

    saveToLocalStorage({
        config,
        generatedSets,
        playedSetIndices: newPlayedIndices,
        timestamp: new Date().toLocaleString()
    });

    const selectedSet = generatedSets[setIndex];
    if (!selectedSet || selectedSet.questions.length === 0) {
        showModal("L·ªói", "B·ªô ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o.", "error");
        return;
    }

    setGameState({
      currentQIndex: 0,
      score: 0,
      isPlaying: true, // Auto start timer
      timeLeft: Number(config.timePerSet) || 60,
      isStar: false,
      showAnswer: false,
      helpQueue: [],
      isHelpRound: false,
      finished: false,
      roundEnded: false,
      questions: selectedSet.questions
    });
    setView('game');
  };

  const toggleTimer = () => {
    setGameState(prev => ({ ...prev, isPlaying: !prev.isPlaying }));
  };

  useEffect(() => {
    if (gameState.isPlaying && gameState.timeLeft > 0 && !gameState.finished && !gameState.roundEnded) {
      timerRef.current = setInterval(() => {
        setGameState(prev => {
          if (prev.timeLeft <= 1) {
            clearInterval(timerRef.current);
            return { ...prev, timeLeft: 0, isPlaying: false };
          }
          return { ...prev, timeLeft: prev.timeLeft - 1 };
        });
      }, 1000);
    } else {
      clearInterval(timerRef.current);
    }
    return () => clearInterval(timerRef.current);
  }, [gameState.isPlaying, gameState.timeLeft, gameState.finished, gameState.roundEnded]);

  const calculateNextState = (prevState, isSkip = false) => {
    const isLastMain = prevState.currentQIndex >= prevState.questions.length - 1;
    const isLastHelp = prevState.isHelpRound && prevState.currentQIndex >= prevState.helpQueue.length - 1;

    const resetFlags = {
      showAnswer: false,
      isStar: false,
      isPlaying: true 
    };

    if (!prevState.isHelpRound) {
      if (isLastMain) {
         return { 
           ...prevState, 
           isPlaying: false, 
           showAnswer: false, 
           roundEnded: true 
         }; 
      } else {
         return { 
           ...prevState, 
           currentQIndex: prevState.currentQIndex + 1, 
           ...resetFlags 
         };
      }
    } else {
      if (isLastHelp) {
        return { ...prevState, finished: true, isPlaying: false, showAnswer: false };
      } else {
        return { 
          ...prevState, 
          currentQIndex: prevState.currentQIndex + 1, 
          ...resetFlags 
        };
      }
    }
  };

  const handleGrade = (correct) => {
    setGameState(prev => {
        let newScore = prev.score;
        let newHelpQueue = [...prev.helpQueue];
        const isHelp = prev.isHelpRound;
        const currentQ = prev.questions[prev.currentQIndex];

        if (correct) {
            if (isHelp) newScore += 2.5; 
            else newScore += prev.isStar ? 10 : 5; 
        } else {
            if (!isHelp) {
                newScore += prev.isStar ? -5 : 0; 
                newHelpQueue.push(currentQ);
            }
        }

        const stateAfterGrade = { ...prev, score: newScore, helpQueue: newHelpQueue };
        return calculateNextState(stateAfterGrade);
    });
  };

  const handleSkip = () => {
     setGameState(prev => {
       let newScore = prev.score;
       let newHelpQueue = [...prev.helpQueue];
       const currentQ = prev.questions[prev.currentQIndex];

       if (prev.isStar && !prev.isHelpRound) newScore -= 5;
       if (!prev.isHelpRound) newHelpQueue.push(currentQ);

       const stateAfterSkip = { ...prev, score: newScore, helpQueue: newHelpQueue };
       return calculateNextState(stateAfterSkip, true);
     });
  };

  const startHelpRound = () => {
    setGameState(prev => ({
      ...prev,
      questions: prev.helpQueue, 
      currentQIndex: 0,
      isHelpRound: true,
      isPlaying: false, 
      showAnswer: false,
      isStar: false,
      roundEnded: false,
      timeLeft: prev.timeLeft 
    }));
    showModal("V√≤ng Tr·ª£ Gi√∫p", "B·∫Øt ƒë·∫ßu ph·∫ßn thi d√†nh cho c√°c th√≠ sinh c√≤n l·∫°i! Th·ªùi gian s·∫Ω ti·∫øp t·ª•c ƒë·∫øm ng∆∞·ª£c.", "info");
  };

  // --- RENDERERS ---

  if (!libsLoaded) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-white">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-yellow-500 mb-4"></div>
        <p>ƒêang t·∫£i th∆∞ vi·ªán To√°n h·ªçc & X·ª≠ l√Ω file...</p>
      </div>
    );
  }

  // 1. INPUT SCREEN
  if (view === 'input') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white font-sans p-4 md:p-6">
        <div className="max-w-6xl mx-auto space-y-8">
          <header className="text-center space-y-2">
            <h1 className="text-2xl md:text-4xl font-bold text-yellow-400 uppercase tracking-widest flex items-center justify-center gap-3">
              <Trophy size={32} className="md:w-10 md:h-10" /> V√íNG 1: KH·ªûI ƒê·ªòNG C√ôNG ƒê·ªíNG ƒê·ªòI
            </h1>
            <p className="text-slate-400 text-sm md:text-base">T√°c gi·∫£: Nguy·ªÖn Tr∆∞·ªùng Sinh ƒêQ</p>
          </header>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            {/* C·ªôt tr√°i: C·∫•u h√¨nh & LOAD */}
            <div className="space-y-6">
                
                {/* N√öT T·∫¢I D·ªÆ LI·ªÜU L∆ØU TR·ªÆ */}
                {hasSavedData && (
                    <div className="bg-blue-600/20 border border-blue-500/50 p-6 rounded-2xl backdrop-blur-sm animate-in zoom-in duration-300">
                        <h2 className="text-lg md:text-xl font-bold text-blue-300 mb-3 flex items-center gap-2">
                            <FolderOpen size={24} /> Ti·∫øp t·ª•c phi√™n l√†m vi·ªác
                        </h2>
                        <p className="text-slate-300 mb-4 text-sm">T√¨m th·∫•y d·ªØ li·ªáu b·ªô ƒë·ªÅ ƒë√£ l∆∞u t·ª´ tr∆∞·ªõc. B·∫°n c√≥ mu·ªën t·∫£i l·∫°i kh√¥ng?</p>
                        <div className="flex gap-3">
                            <button 
                                onClick={handleLoadData}
                                className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition text-sm md:text-base"
                            >
                                <RefreshCw size={20} /> M·ªü b·ªô ƒë·ªÅ ƒë√£ l∆∞u
                            </button>
                            <button 
                                onClick={handleClearData}
                                className="bg-red-600/20 hover:bg-red-600/40 text-red-300 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition border border-red-500/30"
                                title="X√≥a d·ªØ li·ªáu c≈©"
                            >
                                <Trash2 size={20} />
                            </button>
                        </div>
                    </div>
                )}

                {/* IMPORT JSON BUTTON */}
                <div className="bg-slate-700/50 border border-slate-600 p-4 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 className="font-bold text-slate-200 text-sm">Nh·∫≠p d·ªØ li·ªáu t·ª´ file JSON</h3>
                        <p className="text-slate-400 text-xs">Kh√¥i ph·ª•c t·ª´ m√°y t√≠nh</p>
                    </div>
                    <label className="w-full sm:w-auto text-center cursor-pointer bg-slate-600 hover:bg-slate-500 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition">
                        <Upload size={16} /> Ch·ªçn File
                        <input type="file" accept=".json" onChange={handleImportFile} className="hidden" />
                    </label>
                </div>

                <div className="bg-white/5 p-6 rounded-2xl border border-white/10 shadow-xl backdrop-blur-sm h-fit">
                <h2 className="text-lg md:text-xl font-bold mb-4 flex items-center gap-2 text-blue-400">
                    <Settings size={20} /> C·∫•u h√¨nh b·ªô ƒë·ªÅ m·ªõi
                </h2>
                <div className="space-y-4">
                    <div>
                    <label className="block text-sm text-slate-300 mb-1">S·ªë l∆∞·ª£ng b·ªô ƒë·ªÅ (Th√≠ sinh)</label>
                    <input 
                        type="number" 
                        value={config.numSets}
                        onChange={(e) => setConfig({...config, numSets: e.target.value === '' ? '' : parseInt(e.target.value)})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-yellow-500 focus:outline-none"
                    />
                    </div>
                    <div>
                    <label className="block text-sm text-slate-300 mb-1">S·ªë c√¢u h·ªèi m·ªói b·ªô</label>
                    <input 
                        type="number" 
                        value={config.questionsPerSet}
                        onChange={(e) => setConfig({...config, questionsPerSet: e.target.value === '' ? '' : parseInt(e.target.value)})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-yellow-500 focus:outline-none"
                    />
                    </div>
                    <div>
                    <label className="block text-sm text-slate-300 mb-1">Th·ªùi gian m·ªói g√≥i (gi√¢y)</label>
                    <input 
                        type="number" 
                        value={config.timePerSet}
                        onChange={(e) => setConfig({...config, timePerSet: e.target.value === '' ? '' : parseInt(e.target.value)})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-yellow-500 focus:outline-none"
                    />
                    </div>
                </div>
                </div>
            </div>

            <div className="space-y-6">
              <div className="bg-white/5 p-6 rounded-2xl border border-white/10 shadow-xl backdrop-blur-sm flex flex-col h-[500px]">
                <h2 className="text-lg md:text-xl font-bold mb-4 flex items-center gap-2 text-green-400"><FileText size={20} /> D·ªØ li·ªáu ngu·ªìn</h2>
                <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                  <div className="border-2 border-dashed border-slate-600 rounded-xl p-4 text-center hover:border-yellow-500 transition cursor-pointer relative group shrink-0">
                    <input type="file" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".txt,.docx,.pdf" />
                    <div className="group-hover:scale-110 transition duration-300"><Upload className="mx-auto text-slate-400 mb-1" size={24} /><p className="text-sm text-slate-300">T·∫£i file .txt, .docx, .pdf</p></div>
                  </div>
                  <textarea value={rawInput} onChange={(e) => setRawInput(e.target.value)} placeholder={`Y√™u c·∫ßu ƒë·ªãnh d·∫°ng:\nC√¢u 1 (H) | ƒê√°p √°n 1\nC√¢u 2 [NB] | ƒê√°p √°n 2\n\n(H·ªá th·ªëng s·∫Ω t·ª± chia ƒë·ªÅu c√°c c√¢u c√≥ c√πng m·ª©c ƒë·ªô)`} className="w-full flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 font-mono focus:border-yellow-500 focus:outline-none resize-none" ></textarea>
                </div>
              </div>
              {parseErrors.length > 0 && (
                <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
                   <h3 className="text-red-400 font-bold mb-2 flex items-center gap-2"><AlertTriangle size={18} /> Nh·∫≠t k√Ω ({parseErrors.length} l·ªói)</h3>
                   <div className="max-h-32 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                     {parseErrors.map((err, idx) => (<div key={idx} className="text-xs bg-red-900/40 p-2 rounded text-red-200"><span className="font-bold text-red-300">D√≤ng {err.line}:</span> {err.msg}</div>))}
                   </div>
                </div>
              )}
            </div>
          </div>
          <div className="text-center pb-8">
            <button onClick={parseData} className="w-full sm:w-auto bg-gradient-to-r from-yellow-500 to-amber-600 text-black font-bold py-4 px-12 rounded-full text-lg md:text-xl hover:scale-105 transition shadow-[0_0_20px_rgba(234,179,8,0.5)] uppercase flex items-center justify-center gap-2 mx-auto"><Calculator size={24} /> Ki·ªÉm tra & T·∫°o B·ªô ƒê·ªÅ</button>
          </div>
        </div>
        <Modal isOpen={modal.open} title={modal.title} message={modal.message} type={modal.type} onClose={() => setModal({...modal, open: false})} />
      </div>
    );
  }

  // 2. DASHBOARD (TEACHER/MANAGER VIEW)
  if (view === 'dashboard') {
    return (
      <div className="min-h-screen bg-slate-100 p-4 md:p-6 font-sans">
        <header className="flex flex-col lg:flex-row justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm gap-4">
          <h1 className="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Settings className="text-blue-600"/> Dashboard Qu·∫£n L√Ω (Gi√°o vi√™n)
          </h1>
          <div className="flex flex-wrap gap-2 md:gap-3 justify-center">
             <button onClick={() => setView('selection')} className="bg-blue-600 text-white hover:bg-blue-700 font-bold px-3 py-2 md:px-4 rounded-lg flex items-center gap-2 shadow-md animate-pulse text-sm md:text-base">
                <MonitorPlay size={20} /> TR√åNH CHI·∫æU
             </button>
             {/* N√öT L∆ØU & XU·∫§T */}
             <div className="flex bg-gray-100 rounded-lg p-1 gap-1">
                <button onClick={handleSaveData} className="bg-white hover:bg-gray-50 text-slate-700 font-medium px-2 py-2 md:px-3 rounded-md flex items-center gap-1 md:gap-2 shadow-sm border border-gray-200 text-xs md:text-sm" title="L∆∞u v√†o tr√¨nh duy·ªát">
                    <Save size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">L∆∞u</span>
                </button>
                <button onClick={handleExportData} className="bg-white hover:bg-gray-50 text-slate-700 font-medium px-2 py-2 md:px-3 rounded-md flex items-center gap-1 md:gap-2 shadow-sm border border-gray-200 text-xs md:text-sm" title="T·∫£i file JSON d·ª± ph√≤ng">
                    <Download size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Xu·∫•t file</span>
                </button>
                <button onClick={handleExportPlayableHTML} className="bg-white hover:bg-gray-50 text-slate-700 font-medium px-2 py-2 md:px-3 rounded-md flex items-center gap-1 md:gap-2 shadow-sm border border-gray-200 text-xs md:text-sm" title="T·∫£i file Game HTML v·ªÅ m√°y">
                    <Share2 size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Game</span>
                </button>
             </div>
             {/* TOGGLE SWAP MODE */}
             <button 
                onClick={() => { setSwapMode(!swapMode); setSwapSource(null); }} 
                className={`font-medium flex items-center gap-1 border px-2 py-2 md:px-3 rounded-lg transition text-xs md:text-sm ${swapMode ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-purple-700 border-purple-300 hover:bg-purple-50'}`}
             >
                <ArrowLeftRight size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Ho√°n ƒë·ªïi</span>
             </button>
             
             <button onClick={() => setView('input')} className="text-slate-500 hover:text-slate-800 font-medium flex items-center gap-1 border px-2 py-2 md:px-3 rounded-lg text-xs md:text-sm">
                <Edit3 size={16} className="md:w-[18px] md:h-[18px]" />
             </button>
          </div>
        </header>

        {swapMode && (
            <div className="bg-purple-100 text-purple-800 px-4 py-2 rounded-lg mb-6 border border-purple-200 flex items-center gap-2 animate-in slide-in-from-top-2 text-sm md:text-base">
                <ArrowLeftRight size={20}/>
                <span><strong>Ch·∫ø ƒë·ªô Ho√°n ƒë·ªïi ƒëang b·∫≠t:</strong> Click v√†o m·ªôt c√¢u h·ªèi ƒë·ªÉ ch·ªçn, sau ƒë√≥ click v√†o c√¢u h·ªèi kh√°c ƒë·ªÉ tr√°o ƒë·ªïi v·ªã tr√≠ c·ªßa ch√∫ng.</span>
            </div>
        )}

        {/* List for checking/editing only */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {generatedSets.map((set, setIdx) => (
            <div key={set.id} className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-[500px] md:h-[600px]">
                <div className="bg-slate-700 p-4 text-white shrink-0 flex justify-between">
                    <h3 className="text-base md:text-lg font-bold">{set.name}</h3>
                    <span className="text-xs bg-slate-600 px-2 py-1 rounded">{set.questions.length} c√¢u</span>
                </div>
                <div className="p-4 flex-1 overflow-y-auto space-y-4 bg-slate-50 custom-scrollbar">
                    {set.questions.map((q, qIdx) => {
                        // Determine visual state for swap mode
                        const isSelected = swapSource && swapSource.setIdx === setIdx && swapSource.qIdx === qIdx;
                        const isModeActive = swapMode;
                        
                        return (
                            <div 
                                key={q.id} 
                                onClick={() => handleSwapSelect(setIdx, qIdx)}
                                className={`bg-white p-3 md:p-4 rounded-lg border text-sm group relative transition-all duration-200
                                    ${isModeActive ? 'cursor-pointer hover:shadow-lg' : 'hover:shadow-md'}
                                    ${isSelected ? 'border-purple-500 ring-2 ring-purple-300 bg-purple-50' : 'border-slate-200'}
                                    ${isModeActive && !isSelected ? 'hover:border-purple-300' : ''}
                                `}
                            >
                                {!swapMode && (
                                    <button onClick={(e) => { e.stopPropagation(); handleEditClick(setIdx, qIdx, q); }} className="absolute top-2 right-2 p-1 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Ch·ªânh s·ª≠a"><Edit3 size={16} /></button>
                                )}
                                
                                {isModeActive && (
                                    <div className="absolute top-2 right-2 text-purple-400">
                                            <ArrowLeftRight size={16} />
                                    </div>
                                )}

                                <div className="font-bold text-slate-800 mb-2 pr-6">
                                    <span className="text-blue-600 mr-1">C√¢u {qIdx + 1}:</span>
                                    {/* Display Level Tag if exists */}
                                    {q.level !== 'DEFAULT' && <span className="bg-purple-100 text-purple-800 text-xs px-2 py-0.5 rounded border border-purple-200 mr-2 font-mono">[{q.level}]</span>}
                                    <LatexContent content={q.question} className="inline text-slate-800" />
                                </div>
                                <div className="bg-green-50 text-green-800 p-2 rounded border border-green-100 mt-2 text-xs md:text-sm">
                                    <span className="font-bold text-xs uppercase text-green-600 block mb-1">ƒê√°p √°n:</span>
                                    <LatexContent content={q.answer} className="font-medium" />
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
          ))}
        </div>

        {/* Modal Edit (Reuse) */}
        {editingQ && (
          <Modal isOpen={true} title="Ch·ªânh s·ª≠a c√¢u h·ªèi" type="edit" onClose={() => setEditingQ(null)}>
            <div className="space-y-4">
               <div><label className="block text-sm font-bold text-gray-700 mb-1">N·ªôi dung c√¢u h·ªèi</label><textarea value={editingQ.question} onChange={(e) => setEditingQ({...editingQ, question: e.target.value})} className="w-full p-2 border rounded-lg h-24 focus:ring-2 focus:ring-blue-500 outline-none" /></div>
               <div><label className="block text-sm font-bold text-gray-700 mb-1">ƒê√°p √°n</label><textarea value={editingQ.answer} onChange={(e) => setEditingQ({...editingQ, answer: e.target.value})} className="w-full p-2 border rounded-lg h-24 focus:ring-2 focus:ring-blue-500 outline-none" /></div>
               <div className="flex justify-end pt-2"><button onClick={saveEditedQuestion} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2"><Save size={18}/> L∆∞u thay ƒë·ªïi</button></div>
            </div>
          </Modal>
        )}
      </div>
    );
  }

  // 3. SELECTION SCREEN (PLAYER VIEW - SECURE)
  if (view === 'selection') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-900 to-slate-900 p-4 md:p-8 font-sans flex flex-col">
        <header className="flex flex-col md:flex-row justify-between items-center mb-8 md:mb-12 gap-4">
            <div className="text-center md:text-left">
                <h1 className="text-2xl md:text-4xl font-bold text-white uppercase tracking-widest drop-shadow-md">
                   V√íNG 1-KH·ªûI ƒê·ªòNG C√ôNG ƒê·ªíNG ƒê·ªòI
                </h1>
                <p className="text-blue-300 mt-2 text-sm md:text-base">Vui l√≤ng ch·ªçn g√≥i c√¢u h·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu ph·∫ßn thi</p>
            </div>
            <div className="flex flex-wrap gap-2 md:gap-4 justify-center">
                 {/* N√öT L∆ØU & XU·∫§T NGAY T·∫†I M√ÄN H√åNH CH·ªåN */}
                 <div className="flex bg-blue-800/50 rounded-lg p-1 gap-1 border border-blue-700/50">
                    <button onClick={handleSaveData} className="text-blue-200 hover:text-white hover:bg-blue-700 font-medium px-2 py-2 md:px-3 rounded-md flex items-center gap-1 md:gap-2 transition text-xs md:text-sm" title="L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i">
                        <Save size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">L∆∞u</span>
                    </button>
                    {/* BUTTON T·∫¢I GAME HTML M·ªöI */}
                    <button onClick={handleExportPlayableHTML} className="text-blue-200 hover:text-white hover:bg-blue-700 font-medium px-2 py-2 md:px-3 rounded-md flex items-center gap-1 md:gap-2 transition text-xs md:text-sm" title="T·∫£i file Game HTML v·ªÅ m√°y">
                        <Download size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Xu·∫•t Game</span>
                    </button>
                 </div>

                 <button onClick={() => setPlayedSetIndices([])} className="text-orange-400 hover:text-orange-300 font-medium flex items-center gap-1 px-2 py-2 md:px-3 border border-orange-400/50 rounded-lg bg-orange-900/20 text-xs md:text-sm">
                    <RefreshCw size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Reset</span>
                 </button>
                 <button onClick={() => setView('dashboard')} className="text-slate-400 hover:text-white font-medium flex items-center gap-1 px-2 py-2 md:px-3 border border-slate-600 rounded-lg text-xs md:text-sm">
                    <ArrowLeft size={16} className="md:w-[18px] md:h-[18px]" /> <span className="hidden sm:inline">Qu·∫£n l√Ω</span>
                 </button>
            </div>
        </header>

        <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8 items-center justify-center content-start md:content-center">
             {generatedSets.map((set, idx) => {
                 const isPlayed = playedSetIndices.includes(idx);
                 return (
                     <button 
                        key={set.id}
                        disabled={isPlayed}
                        onClick={() => initGame(idx)}
                        className={`group relative h-48 md:h-64 rounded-2xl flex flex-col items-center justify-center border-2 transition-all duration-300 transform
                            ${isPlayed 
                                ? 'bg-slate-800/50 border-slate-700 opacity-50 cursor-not-allowed scale-95' 
                                : 'bg-white/10 border-blue-400/50 hover:bg-blue-600 hover:border-blue-400 hover:scale-105 hover:shadow-[0_0_40px_rgba(37,99,235,0.6)] cursor-pointer'
                            }
                        `}
                     >
                        <div className={`p-4 md:p-6 rounded-full mb-2 md:mb-4 transition-colors ${isPlayed ? 'bg-slate-700 text-slate-500' : 'bg-white text-blue-900 group-hover:scale-110'}`}>
                            {isPlayed ? <CheckCircle size={32} className="md:w-10 md:h-10" /> : <FileText size={32} className="md:w-10 md:h-10" />}
                        </div>
                        <h2 className={`text-xl md:text-2xl font-bold uppercase tracking-wider ${isPlayed ? 'text-slate-500' : 'text-white'}`}>
                            {set.name}
                        </h2>
                        {isPlayed && <span className="absolute top-2 right-2 md:top-4 md:right-4 text-green-500 font-bold text-xs border border-green-500 px-2 py-1 rounded">ƒê√É CH∆†I</span>}
                     </button>
                 )
             })}
        </div>
      </div>
    );
  }

  // 4. GAME INTERFACE
  if (view === 'game') {
    // Safety check for questions
    if (!gameState.questions || gameState.questions.length === 0) {
        return (
            <div className="min-h-screen bg-[#0f172a] text-white flex items-center justify-center flex-col">
                <AlertCircle size={48} className="text-red-500 mb-4" />
                <h2 className="text-2xl font-bold">L·ªói D·ªØ Li·ªáu</h2>
                <p>Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi. Vui l√≤ng quay l·∫°i.</p>
                <button onClick={() => setView('selection')} className="mt-4 px-6 py-2 bg-slate-700 rounded-lg hover:bg-slate-600">Quay l·∫°i</button>
            </div>
        );
    }

    const currentQuestion = gameState.questions[gameState.currentQIndex];
    // Double check currentQuestion exists
    if (!currentQuestion) {
         return (
            <div className="min-h-screen bg-[#0f172a] text-white flex items-center justify-center flex-col">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
                <p>ƒêang t·∫£i c√¢u h·ªèi...</p>
            </div>
        );
    }

    const isWaitingForHelp = !gameState.isHelpRound && gameState.roundEnded && gameState.helpQueue.length > 0;
    const isTotallyFinished = gameState.finished || (!gameState.isHelpRound && gameState.roundEnded && gameState.helpQueue.length === 0);

    return (
      <div className="min-h-screen bg-[#0f172a] text-white overflow-hidden relative font-sans flex flex-col">
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
          <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 blur-[100px] rounded-full"></div>
          <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-yellow-500/10 blur-[100px] rounded-full"></div>
        </div>

        <header className="relative z-10 flex flex-col md:flex-row items-center justify-between px-4 md:px-6 py-4 bg-white/5 border-b border-white/10 backdrop-blur-md gap-4">
          <div className="flex items-center gap-2 md:gap-4 w-full md:w-auto justify-between md:justify-start">
            <div className="bg-blue-600 px-3 md:px-4 py-1 rounded text-xs md:text-sm font-bold shadow-lg truncate max-w-[150px] md:max-w-none">
              {generatedSets[currentSetIndex]?.name || "B·ªô ƒë·ªÅ"}
            </div>
            <div className={`px-3 md:px-4 py-1 rounded text-xs md:text-sm font-bold shadow-lg ${gameState.isHelpRound ? 'bg-red-600 animate-pulse' : 'bg-slate-700'}`}>
              {gameState.isHelpRound ? 'V√íNG TR·ª¢ GI√öP' : 'V√íNG CH√çNH'}
            </div>
          </div>
          <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
            <div className="flex items-center gap-2 md:gap-4 bg-black/20 px-4 md:px-5 py-2 rounded-2xl border border-white/5">
              <span className="text-xs md:text-sm font-bold text-slate-300 uppercase tracking-wider">T·ªïng ƒëi·ªÉm</span>
              <span className="text-3xl md:text-5xl font-bold text-yellow-400 font-mono leading-none drop-shadow-[0_2px_10px_rgba(250,204,21,0.5)]">{gameState.score}</span>
            </div>
            {/* Quay v·ªÅ Selection Screen */}
            <button onClick={() => setView('selection')} className="flex items-center gap-2 px-3 md:px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition text-xs md:text-sm font-bold border border-slate-500 shadow-md whitespace-nowrap">
              <Home size={16} className="md:w-[18px] md:h-[18px]" /> V·ªÅ Menu
            </button>
          </div>
        </header>

        <main className="relative z-10 flex-1 flex flex-col items-center justify-center p-4 md:p-6 w-full max-w-7xl mx-auto">
          {isTotallyFinished ? (
            <div className="text-center animate-in zoom-in duration-500">
              <Trophy size={80} className="md:w-[100px] md:h-[100px] text-yellow-400 mx-auto mb-6 drop-shadow-[0_0_30px_rgba(250,204,21,0.6)]" />
              <h2 className="text-4xl md:text-5xl font-bold text-white mb-4">HO√ÄN TH√ÄNH</h2>
              <p className="text-xl md:text-2xl text-slate-300">T·ªïng ƒëi·ªÉm: <span className="text-yellow-400 font-bold">{gameState.score}</span></p>
              <button onClick={() => setView('selection')} className="mt-8 px-6 py-3 md:px-8 bg-white text-slate-900 font-bold rounded-full hover:bg-yellow-400 transition text-sm md:text-base">V·ªÅ Menu Ch·ªçn B·ªô ƒê·ªÅ</button>
            </div>
          ) : isWaitingForHelp ? (
              <div className="text-center animate-in zoom-in duration-500">
                 <AlertTriangle size={60} className="md:w-[80px] md:h-[80px] text-orange-500 mx-auto mb-6" />
                 <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">K·∫æT TH√öC V√íNG CH√çNH</h2>
                 <p className="text-lg md:text-xl text-slate-300 mb-6">B·∫°n c√≥ <span className="text-red-400 font-bold">{gameState.helpQueue.length}</span> c√¢u h·ªèi c·∫ßn tr·ª£ gi√∫p.</p>
                 <button onClick={startHelpRound} className="px-6 py-3 md:px-8 md:py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl animate-pulse hover:animate-none hover:scale-105 transition shadow-lg flex items-center gap-2 mx-auto text-sm md:text-base">
                    <Clock size={20} className="md:w-[24px] md:h-[24px]" /> B·∫ÆT ƒê·∫¶U V√íNG TR·ª¢ GI√öP
                 </button>
              </div>
          ) : (
            <>
              <div className="w-full bg-white/10 border border-white/20 rounded-3xl p-6 md:p-12 backdrop-blur-md shadow-2xl relative min-h-[300px] md:min-h-[400px] flex flex-col justify-center">
                <div className="absolute top-4 left-4 md:top-6 md:left-8 flex flex-wrap items-center gap-2 md:gap-3">
                  <span className="bg-slate-800 text-slate-300 px-3 py-1 rounded-full text-xs md:text-sm font-bold border border-slate-600">
                    C√¢u {gameState.currentQIndex + 1} / {gameState.questions.length}
                  </span>
                  {gameState.isStar && <span className="bg-yellow-500 text-black px-3 py-1 rounded-full text-xs md:text-sm font-bold flex items-center gap-1 animate-pulse shadow-[0_0_15px_rgba(234,179,8,0.8)]"><Star size={14} fill="black" /> NG√îI SAO HY V·ªåNG</span>}
                </div>
                <div className="text-center space-y-4 md:space-y-8 mt-8 md:mt-6">
                  <div className="text-xl sm:text-2xl md:text-4xl lg:text-5xl font-bold leading-tight drop-shadow-md text-white">
                      <LatexContent content={currentQuestion.question} />
                  </div>
                  <div className={`transition-all duration-300 overflow-hidden ${gameState.showAnswer ? 'max-h-80 opacity-100 mt-4 md:mt-8' : 'max-h-0 opacity-0'}`}>
                     <div className="inline-block bg-green-600/90 text-white px-4 md:px-8 py-2 md:py-4 rounded-xl text-lg md:text-2xl font-bold shadow-lg border border-green-400/50">
                        <LatexContent content={currentQuestion.answer} />
                     </div>
                  </div>
                </div>
              </div>

              <div className="w-full mt-6 md:mt-8 flex flex-col lg:flex-row items-center justify-between gap-6">
                <div className="flex items-center gap-4">
                  <div className="relative w-16 h-16 md:w-24 md:h-24 shrink-0">
                      <svg className="w-full h-full transform -rotate-90">
                        <circle cx="50%" cy="50%" r="45%" stroke="currentColor" strokeWidth="6" fill="transparent" className="text-slate-700" />
                        <circle cx="50%" cy="50%" r="45%" stroke="currentColor" strokeWidth="6" fill="transparent" className={`${gameState.timeLeft < 10 ? 'text-red-500' : 'text-blue-500'} transition-all duration-1000`} strokeDasharray={251} strokeDashoffset={251 - (251 * gameState.timeLeft) / (Number(config.timePerSet) || 60)} />
                      </svg>
                      <span className="absolute inset-0 flex items-center justify-center text-lg md:text-2xl font-bold font-mono">{gameState.timeLeft}s</span>
                  </div>
                  <button onClick={toggleTimer} className="p-3 md:p-4 bg-slate-700 rounded-full hover:bg-slate-600 transition shadow-lg active:scale-95">{gameState.isPlaying ? <Pause size={20} className="md:w-[24px] md:h-[24px]" /> : <Play size={20} className="md:w-[24px] md:h-[24px]" />}</button>
                  <button onClick={() => setGameState(p => ({...p, timeLeft: Number(config.timePerSet) || 60}))} className="p-3 md:p-4 bg-slate-700 rounded-full hover:bg-slate-600 transition shadow-lg active:scale-95" title="Reset th·ªùi gian"><RotateCcw size={20} className="md:w-[24px] md:h-[24px]" /></button>
                </div>
                <div className="flex flex-wrap justify-center items-center gap-2 md:gap-4 w-full lg:w-auto">
                  {!gameState.showAnswer ? (
                    <>
                      {!gameState.isHelpRound && <button onClick={() => setGameState(p => ({...p, isStar: !p.isStar}))} className={`px-4 py-3 md:px-6 md:py-4 rounded-xl text-sm md:text-base font-bold flex items-center gap-2 transition border ${gameState.isStar ? 'bg-yellow-500 text-black border-yellow-400 shadow-[0_0_20px_rgba(234,179,8,0.5)]' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white'}`}><Star size={20} className={gameState.isStar ? 'fill-black' : ''} /> <span className="hidden sm:inline">Ng√¥i Sao</span></button>}
                      <button onClick={handleSkip} className="px-4 py-3 md:px-6 md:py-4 bg-slate-700 text-slate-200 border border-slate-600 rounded-xl text-sm md:text-base font-bold hover:bg-red-900/50 hover:text-red-200 transition flex items-center gap-2"><SkipForward size={20} /> <span className="hidden sm:inline">B·ªè qua</span></button>
                      <button onClick={() => setGameState(p => ({...p, showAnswer: true, isPlaying: false}))} className="px-4 py-3 md:px-6 md:py-4 bg-blue-600 text-white rounded-xl text-sm md:text-base font-bold hover:bg-blue-500 transition shadow-lg flex items-center gap-2"><Eye size={20} /> Hi·ªán ƒë√°p √°n</button>
                    </>
                  ) : (
                    <>
                        <button onClick={() => handleGrade(false)} className="px-6 py-3 md:px-8 md:py-4 bg-red-600/20 text-red-400 border border-red-600/50 rounded-xl text-sm md:text-base font-bold hover:bg-red-600 hover:text-white transition flex items-center gap-2"><XCircle size={24} /> SAI</button>
                        <button onClick={() => handleGrade(true)} className="px-6 py-3 md:px-8 md:py-4 bg-green-600 text-white rounded-xl text-sm md:text-base font-bold hover:bg-green-500 transition shadow-lg hover:shadow-green-500/30 flex items-center gap-2"><CheckCircle size={24} /> ƒê√öNG</button>
                    </>
                  )}
                </div>
              </div>
            </>
          )}
        </main>
        
        {!gameState.isHelpRound && gameState.helpQueue.length > 0 && <div className="absolute bottom-4 right-4 bg-red-900/80 border border-red-500/50 p-3 rounded-lg backdrop-blur text-xs text-red-200">H√†ng ƒë·ª£i tr·ª£ gi√∫p: <strong>{gameState.helpQueue.length}</strong> c√¢u</div>}
        <Modal isOpen={modal.open} title={modal.title} message={modal.message} type={modal.type} onClose={() => setModal({...modal, open: false})} />
      </div>
    );
  }

  return null;
}
