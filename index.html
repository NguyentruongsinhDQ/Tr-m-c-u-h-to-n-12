<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-RESCUE: Tr·∫°m C·ª©u H·ªô To√°n 12 (Merged Ultimate)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            options: { enableMenu: false },
            startup: { ready: () => MathJax.startup.defaultReady() }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;900&display=swap');
        
        /* Base Variables */
        :root { --bg-primary: #f8fafc; --text-primary: #1e293b; }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.5s ease, color 0.3s ease; overflow-x: hidden; }
        
        /* Dark Mode */
        body.dark-mode .bg-white { background-color: #1e293b !important; color: #f1f5f9; border-color: #334155; }
        body.dark-mode .bg-slate-50 { background-color: #0f172a !important; color: #cbd5e1; border-color: #334155; }
        body.dark-mode .text-slate-800 { color: #f8fafc !important; }
        body.dark-mode .text-slate-700 { color: #e2e8f0 !important; }
        body.dark-mode .text-slate-600 { color: #cbd5e1 !important; }
        body.dark-mode .text-slate-500 { color: #94a3b8 !important; }
        body.dark-mode .border-slate-100, body.dark-mode .border-slate-200 { border-color: #334155 !important; }
        body.dark-mode input, body.dark-mode textarea, body.dark-mode select { background-color: #0f172a; border-color: #475569; color: white; }
        
        /* Seasons */
        body.season-spring { background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%); }
        body.season-spring.dark-mode { background: linear-gradient(135deg, #2e1065 0%, #4c1d95 100%); }
        body.season-summer { background: linear-gradient(135deg, #fef9c3 0%, #fee2e2 100%); }
        body.season-summer.dark-mode { background: linear-gradient(135deg, #450a0a 0%, #7c2d12 100%); }
        body.season-autumn { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
        body.season-autumn.dark-mode { background: linear-gradient(135deg, #431407 0%, #78350f 100%); }
        body.season-winter { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        body.season-winter.dark-mode { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }

        /* Effects */
        .falling-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        .falling-item { position: absolute; top: -10%; animation: fallDown linear infinite; opacity: 0.8; }
        @keyframes fallDown { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        #summer-tree { position: fixed; bottom: 0; left: -20px; width: 300px; height: 300px; z-index: 0; pointer-events: none; display: none; }
        body.season-summer #summer-tree { display: block; }
        body.season-summer.dark-mode #summer-tree { filter: brightness(0.4); }

        /* Scrollbar & Misc */
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .role-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .bg-genz { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .text-gradient { background: -webkit-linear-gradient(45deg, #6a11cb, #2575fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .question-item { page-break-inside: avoid; margin-bottom: 20px; } .falling-container, #summer-tree { display: none !important; } }
        #react-hidden-render { position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        .word-content img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
        .word-content table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .word-content td, .word-content th { border: 1px solid #ddd; padding: 8px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #e2e8f0; width: 90%; max-width: 800px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; }
        body.dark-mode .modal-content { background-color: #1e293b; border-color: #334155; }
        .delete-btn { opacity: 0.6; transition: opacity 0.2s; cursor: pointer; color: #ef4444; }
        .delete-btn:hover { opacity: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; } .custom-scrollbar::-webkit-scrollbar-track { background: transparent; } .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Confetti */
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: confetti-fall 3s linear infinite; z-index: 9999; pointer-events: none; }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen flex flex-col relative">

    <div id="falling-container" class="falling-container"></div>
    <div id="summer-tree"><svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><path d="M90 200 L90 120 L80 100 L95 120 L95 200 Z" fill="#8B4513"/><rect x="90" y="120" width="15" height="80" fill="#8B4513"/><circle cx="60" cy="90" r="30" fill="#22c55e" opacity="0.9"/><circle cx="140" cy="100" r="35" fill="#22c55e" opacity="0.9"/><circle cx="100" cy="60" r="40" fill="#22c55e"/><circle cx="70" cy="80" r="5" fill="#ef4444"/><circle cx="110" cy="50" r="5" fill="#ef4444"/><circle cx="130" cy="90" r="5" fill="#ef4444"/><circle cx="90" cy="70" r="5" fill="#ef4444"/><circle cx="50" cy="100" r="5" fill="#ef4444"/></svg></div>

    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-200 transition-colors duration-300">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="app.goLanding()">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white w-10 h-10 flex items-center justify-center rounded-xl shadow-lg shadow-indigo-200 group-hover:scale-105 transition-transform duration-300">
                    <i class="fa-solid fa-life-ring fa-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-slate-800 tracking-tight leading-none group-hover:text-indigo-600 transition-colors">G-RESCUE</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Ultimate Gen Z</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="app.toggleDarkMode()" id="dark-mode-btn" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition shadow-sm border border-slate-200" title="Ch·∫ø ƒë·ªô Dark Mode"><i class="fa-solid fa-moon"></i></button>
                <button onclick="app.goLanding()" class="text-sm font-medium text-slate-500 hover:text-red-600 transition flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-50"><i class="fa-solid fa-right-from-bracket"></i> <span class="hidden sm:inline">Tho√°t / ƒê·ªïi vai tr√≤</span></button>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-grow container mx-auto px-4 py-6 flex flex-col justify-center relative z-10"></main>

    <div id="previewModal" class="modal fade-in">
        <div class="modal-content relative">
            <button onclick="document.getElementById('previewModal').style.display='none'" class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-red-100 hover:text-red-600 transition text-lg z-10">&times;</button>
            <div id="previewContent" class="overflow-y-auto max-h-[80vh] custom-scrollbar"></div>
        </div>
    </div>

    <div id="export-processing" class="fixed inset-0 bg-white z-[9999] hidden flex flex-col items-center justify-center">
        <div class="text-4xl text-blue-600 mb-4"><i class="fa-solid fa-print fa-bounce"></i></div>
        <h2 class="text-xl font-bold text-slate-800">ƒêang t·∫°o b·∫£n in PDF...</h2>
        <p class="text-slate-500 mt-2">Vui l√≤ng ƒë·ª£i trong khi h·ªá th·ªëng x·ª≠ l√Ω h√¨nh ·∫£nh v√† c√¥ng th·ª©c.</p>
        <div class="w-64 bg-slate-200 h-2 rounded-full mt-4 overflow-hidden"><div class="bg-blue-600 h-full w-full animate-pulse"></div></div>
    </div>

    <div id="react-hidden-render"></div>
    <canvas id="tempCanvas" style="display: none;"></canvas>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const BBTRenderer = ({ data }) => {
            const strokeColor = "#000"; const fontMain = "16px 'Times New Roman', serif"; const fontMath = "italic 16px 'Times New Roman', serif";
            const formatText = (text) => { if(!text) return ""; return text.replace(/\\infty/g, "‚àû").replace(/\\+\infty/g, "+‚àû").replace(/\\-\infty/g, "‚àí‚àû").replace(/\\times/g, "√ó").replace(/\\in/g, "‚àà").replace(/\\notin/g, "‚àâ").replace(/\\cup/g, "‚à™").replace(/\\cap/g, "‚à©").replace(/\\emptyset/g, "‚àÖ").replace(/\\R/g, "‚Ñù").replace(/\\setminus/g, "\\").replace(/-/g, "‚àí").replace(/\{,\}/g, ",").replace(/\$/g, ""); };
            const getStyle = (text) => { if (!text) return fontMain; const t = text.trim(); if (/^(x|y|y'|f\(x\)|f'\(x\))$/.test(t)) return fontMath; if (t.includes('infty') || t.includes('‚àû')) return fontMath; if (/^[-‚àí+0-9,.;\[\]\(\)\s=<>√ó‚àà‚àâ‚à™‚à©‚àÖ‚Ñù\\]+$/.test(t)) return fontMain; if (/[a-zA-Z√Ä-·ªπ]{2,}/.test(t) || t.includes(' ')) return fontMain; return fontMath; };
            const { labels, xValues, signs, variations, isSignChart } = data;
            const colWidth = 100; const headerWidth = 60; const rowHeight = 45; const yRowHeight = 100;
            const totalHeight = isSignChart ? (rowHeight * 2) : ((rowHeight * 2) + yRowHeight);
            const totalWidth = headerWidth + (xValues.length * colWidth) + 50; 
            const getX = (percent) => headerWidth + (percent * (totalWidth - headerWidth - 60)) + 30;
            const renderArrows = () => { if (!variations || variations.length === 0) return null; const sortedVars = [...variations].sort((a, b) => a.xPercent - b.xPercent); const arrows = [], texts = []; for(let i = 0; i < sortedVars.length - 1; i++) { const p1 = sortedVars[i], p2 = sortedVars[i+1]; if (p2.xPercent > p1.xPercent) { const x1 = getX(p1.xPercent), x2 = getX(p2.xPercent); const padding = 15; const yHigh = (rowHeight * 2) + padding; const yLow = totalHeight - padding; const y1 = p1.type.includes('+') ? yHigh : yLow; const y2 = p2.type.includes('+') ? yHigh : yLow; const angle = Math.atan2(y2 - y1, x2 - x1); const drawX1 = x1 + Math.cos(angle) * 12, drawY1 = y1 + Math.sin(angle) * 12; const drawX2 = x2 - Math.cos(angle) * 12, drawY2 = y2 - Math.sin(angle) * 12; arrows.push(<line key={`arr-${i}`} x1={drawX1} y1={drawY1} x2={drawX2} y2={drawY2} stroke="black" strokeWidth="1.2" markerEnd="url(#arrowhead)" />); } } sortedVars.forEach((v, i) => { const x = getX(v.xPercent); const yBase = v.type.includes('+') ? (rowHeight * 2) + 15 : totalHeight - 15; texts.push(<text key={`v-${i}`} x={x} y={yBase} dominantBaseline="middle" textAnchor="middle" style={{font: getStyle(v.value)}} fill="black">{formatText(v.value)}</text>); }); return <g>{arrows}{texts}</g>; };
            return ( <svg width={totalWidth} height={totalHeight + 2} xmlns="http://www.w3.org/2000/svg" style={{backgroundColor: 'white'}}> <defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="black" /></marker></defs> <rect x="0" y="0" width="100%" height="100%" fill="white" /> <rect x="0.5" y="0.5" width={totalWidth-1} height={totalHeight} fill="none" stroke={strokeColor} strokeWidth="1"/> <line x1={headerWidth} y1="0" x2={headerWidth} y2={totalHeight} stroke={strokeColor} strokeWidth="1" /> <line x1="0" y1={rowHeight} x2={totalWidth} y2={rowHeight} stroke={strokeColor} strokeWidth="1" /> {!isSignChart && <line x1="0" y1={rowHeight * 2} x2={totalWidth} y2={rowHeight * 2} stroke={strokeColor} strokeWidth="1" />} <text x={headerWidth/2} y={rowHeight * 0.5} dominantBaseline="middle" textAnchor="middle" style={{font: fontMath}}>{formatText(labels[0] || "x")}</text> <text x={headerWidth/2} y={rowHeight * 1.5} dominantBaseline="middle" textAnchor="middle" style={{font: fontMath}}>{formatText(labels[1]) || "y'"}</text> {!isSignChart && <text x={headerWidth/2} y={(rowHeight * 2) + (yRowHeight / 2)} dominantBaseline="middle" textAnchor="middle" style={{font: fontMath}}>{formatText(labels[2] || "y")}</text>} {xValues.map((item, i) => <text key={`x-${i}`} x={getX(item.xPercent)} y={rowHeight * 0.5} dominantBaseline="middle" textAnchor="middle" style={{font: getStyle(item.value)}}>{formatText(item.value)}</text>)} {signs.map((item, i) => <text key={`s-${i}`} x={getX(item.xPercent)} y={rowHeight * 1.5} dominantBaseline="middle" textAnchor="middle" style={{font: fontMain}}>{formatText(item.value)}</text>)} {!isSignChart && renderArrows()} </svg> );
        };
        const parseTkzTab = (input) => { const initMatch = input.match(/\\tkzTabInit.*?\{(.*?)\}\s*\{(.*?)\}/s); if (!initMatch) return null; const rowsRaw = initMatch[1].split(',').map(s => s.trim().split('/')[0].replace(/\$/g, '')); const xValuesRaw = initMatch[2].split(',').map(s => s.trim().replace(/\$/g, '')); const isSignChart = rowsRaw.length === 2; const lineMatch = input.match(/\\tkzTabLine\{(.*?)\}/s); let signsRaw = []; if (lineMatch) signsRaw = lineMatch[1].split(',').map(s => s.trim()); const varMatch = input.match(/\\tkzTabVar\{(.*?)\}/s); let variationsRaw = []; if (varMatch) { const regexVar = /([+\-R])\/\s*(.*?)(?=(,|$))/g; let match; while ((match = regexVar.exec(varMatch[1])) !== null) { variationsRaw.push({ type: match[1], value: match[2].replace(/\$/g, '').trim() }); } } const xNodes = xValuesRaw.map((val, i) => ({ value: val, xPercent: i / (xValuesRaw.length - 1) })); const mappedSigns = signsRaw.map((sign, i) => { let xPercent = i / (signsRaw.length - 1); const closestNode = xNodes.find(n => Math.abs(n.xPercent - xPercent) < 0.05); if (sign === '0' || sign === 'z' || sign === 'd') { if(closestNode) xPercent = closestNode.xPercent; } return { value: sign, xPercent }; }); const mappedVariations = variationsRaw.map((v, i) => ({ ...v, xPercent: i / (variationsRaw.length - 1) })); return { type: 'tkz', labels: rowsRaw, xValues: xNodes, signs: mappedSigns, variations: mappedVariations, isSignChart }; };
        window.renderLatexTableToImage = async (latexCode) => { return new Promise((resolve) => { const renderRoot = document.getElementById('react-hidden-render'); let parsedData = null; try { if (latexCode.includes("tkzTabInit")) parsedData = parseTkzTab(latexCode); } catch(e) { console.error(e); resolve(null); return; } if (!parsedData) { resolve(null); return; } const root = ReactDOM.createRoot(renderRoot); root.render(<BBTRenderer data={parsedData} />); setTimeout(() => { const svgElement = renderRoot.querySelector('svg'); if (svgElement) { const svgData = new XMLSerializer().serializeToString(svgElement); const canvas = document.getElementById('tempCanvas'); const ctx = canvas.getContext('2d'); const img = new Image(); const svgW = parseFloat(svgElement.getAttribute("width")) || 500; const svgH = parseFloat(svgElement.getAttribute("height")) || 300; const scale = 2; canvas.width = svgW * scale; canvas.height = svgH * scale; const encodedSvg = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgData); img.onload = () => { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); root.unmount(); resolve(canvas.toDataURL("image/png")); }; img.src = encodedSvg; } else { root.unmount(); resolve(null); } }, 100); }); };
    </script>

    <script>
        const INITIAL_DATA = [{"id":1,"grade":"Kh·ªëi 12","chapter":"Ch∆∞∆°ng I: ·ª®ng d·ª•ng ƒë·∫°o h√†m ƒë·ªÉ kh·∫£o s√°t v√† v·∫Ω ƒë·ªì th·ªã h√†m s·ªë","lesson":"B√†i 1. T√≠nh ƒë∆°n ƒëi·ªáu v√† c·ª±c tr·ªã c·ªßa h√†m s·ªë","level":1,"type":"mcq","variant":0,"content":"Cho h√†m s·ªë $y=f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau. H√†m s·ªë ƒë√£ cho ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o?\n\\begin{center}\\begin{tikzpicture}\n\\tkzTabInit[lgt=1,espcl=2]{$x$/1,$y'$/1,$y$/2}{$-\\infty$,$-1$,$0$,$1$,$+\\infty$}\n\\tkzTabLine{,-,0,+,0,-,0,+,}\n\\tkzTabVar{+/$+\\infty$,-/$-2$,+/$3$,-/$-2$,+/$+\\infty$}\n\\end{tikzpicture}\\end{center}","options":["$(-\\infty; -1)$","$(0; 1)$","$(-1; 0)$","$(1; +\\infty)$"],"correct":2,"theory":"H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n K n·∫øu $f'(x) > 0$ tr√™n K.","steps":["Quan s√°t d√≤ng $y'$.","T√¨m kho·∫£ng mang d·∫•u (+)."],"solution":"D·ª±a v√†o b·∫£ng bi·∫øn thi√™n, ta th·∫•y $y'$ mang d·∫•u (+) tr√™n kho·∫£ng $(-1; 0)$ v√† $(1; +\\infty)$. ƒê√°p √°n: $(-1; 0)$."}];
        const INITIAL_TREE = { "Kh·ªëi 10": {}, "Kh·ªëi 11": {}, "Kh·ªëi 12": { "Ch∆∞∆°ng I: ·ª®ng d·ª•ng ƒë·∫°o h√†m ƒë·ªÉ kh·∫£o s√°t v√† v·∫Ω ƒë·ªì th·ªã h√†m s·ªë": [ "B√†i 1. T√≠nh ƒë∆°n ƒëi·ªáu v√† c·ª±c tr·ªã c·ªßa h√†m s·ªë", "B√†i 2. Gi√° tr·ªã l·ªõn nh·∫•t v√† gi√° tr·ªã nh·ªè nh·∫•t c·ªßa h√†m s·ªë", "B√†i 3. ƒê∆∞·ªùng ti·ªám c·∫≠n c·ªßa ƒë·ªì th·ªã h√†m s·ªë", "B√†i 4. Kh·∫£o s√°t s·ª± bi·∫øn thi√™n v√† v·∫Ω ƒë·ªì th·ªã h√†m s·ªë", "B√†i 5. ·ª®ng d·ª•ng ƒë·∫°o h√†m ƒë·ªÉ gi·∫£i quy·∫øt m·ªôt s·ªë v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn th·ª±c ti·ªÖn" ], "Ch∆∞∆°ng II: V√©ct∆° v√† h·ªá tr·ª•c to·∫° ƒë·ªô trong kh√¥ng gian": [], "Ch∆∞∆°ng III: C√°c s·ªë ƒë·∫∑c tr∆∞ng ƒëo m·ª©c ƒë·ªô ph√¢n t√°n c·ªßa m·∫´u s·ªë li·ªáu gh√©p nh√≥m": [], "Ch∆∞∆°ng IV: Nguy√™n h√†m v√† t√≠ch ph√¢n": [], "Ch∆∞∆°ng V: Ph∆∞∆°ng ph√°p to·∫° ƒë·ªô trong kh√¥ng gian": [], "Ch∆∞∆°ng VI: X√°c su·∫•t c√≥ ƒëi·ªÅu ki·ªán": [] } };
        const DATA_VERSION = 0; 

        const app = {

            // --- 1. H√ÄM H·ªñ TR·ª¢ SINH ID H·ªÜ TH·ªêNG ---
generateBasePrefix(grade, chapter, lesson, type, level) {
    const clean = (str) => {
        if (!str) return "X";
        return str
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // B·ªè d·∫•u ti·∫øng Vi·ªát
            .replace(/Kh·ªëi\s*/i, 'K')
            .replace(/Ch∆∞∆°ng\s*/i, 'C').split(':')[0]
            .replace(/B√†i\s*/i, 'B').split('.')[0]
            .replace(/[^a-zA-Z0-9]/g, ''); // B·ªè k√Ω t·ª± l·∫°
    };
    const safeType = (type || 'MCQ').toUpperCase();
    const safeLevel = level || 1;
    // C·∫•u tr√∫c: K12_C1_B1_MCQ_L1
    return `${clean(grade)}_${clean(chapter)}_${clean(lesson)}_${safeType}_L${safeLevel}`;
},

getNextIndex(prefix) {
    // T√¨m s·ªë th·ª© t·ª± l·ªõn nh·∫•t hi·ªán c√≥ c·ªßa prefix n√†y (ch·ªâ t√≠nh c√¢u g·ªëc variant=0)
    const existing = this.data.filter(q => q.id.toString().startsWith(prefix) && q.variant === 0);
    let maxIndex = 0;
    existing.forEach(q => {
        const parts = q.id.toString().split('_');
        // ID: ..._L1_05 -> L·∫•y ph·∫ßn t·ª≠ cu·ªëi c√πng
        const lastPart = parts[parts.length - 1]; 
        const num = parseInt(lastPart);
        if (!isNaN(num) && num > maxIndex) maxIndex = num;
    });
    return maxIndex;
},

                adminFilter: {
        grade: '',
        chapter: '',
        lesson: ''
    },
            data: [], tree: {}, userRole: null, phase: 0, quiz: [], answers: {}, reviewQueue: [], reviewIndex: 0,
            // --- [M·ªöI] BI·∫æN TR·∫†NG TH√ÅI CHO ID ---
    pendingVariantId: null, 

    // --- [M·ªöI] H√ÄM SINH ID CHU·∫®N (K12_C1_B1...) ---
    generateBasePrefix(grade, chapter, lesson, type, level) {
        const clean = (str) => {
            if(!str) return "X";
            return str
                .replace(/Kh·ªëi\s/i, 'K')
                .replace(/Ch∆∞∆°ng\s/i, 'C').split(':')[0]
                .replace(/B√†i\s/i, 'B').split('.')[0]
                .replace(/[^a-zA-Z0-9]/g, '');
        };
        const safeType = (type || 'MCQ').toUpperCase();
        const safeLevel = level || 1;
        return `${clean(grade)}_${clean(chapter)}_${clean(lesson)}_${safeType}_L${safeLevel}`;
    },

    getNextIndex(prefix) {
        // T√¨m s·ªë th·ª© t·ª± l·ªõn nh·∫•t c·ªßa c√¢u g·ªëc
        const existing = this.data.filter(q => q.id.toString().startsWith(prefix) && (q.variant === 0 || !q.variant));
        let maxIndex = 0;
        existing.forEach(q => {
            const parts = q.id.toString().split('_');
            // ID d·∫°ng ..._L1_05 -> L·∫•y s·ªë 05
            const lastPart = parts[parts.length - 1]; 
            const num = parseInt(lastPart);
            if (!isNaN(num) && num > maxIndex) maxIndex = num;
        });
        return maxIndex;
    }, adminMode: 'manual', adminTab: 'question',
            wordDrafts: [], sel: { g: '', c: '', l: '' }, doneVariants: [], structSel: { g: '' }, searchTerm: '',
            isDarkMode: false, season: 'spring',

            init() {
                const localVer = parseInt(localStorage.getItem('g_rescue_version') || '0');
                const fileVer = (typeof DATA_VERSION !== 'undefined') ? DATA_VERSION : 0;

                if (fileVer > localVer) {
                    this.data = INITIAL_DATA;
                    this.tree = INITIAL_TREE;
                    localStorage.setItem('g_rescue_v6', JSON.stringify(this.data));
                    localStorage.setItem('g_rescue_tree_v1', JSON.stringify(this.tree));
                    localStorage.setItem('g_rescue_version', fileVer);
                    console.log("App synced from File (Newer Version found).");
                } else {
                    const storedData = localStorage.getItem('g_rescue_v6');
                    this.data = storedData ? JSON.parse(storedData) : INITIAL_DATA;
                    const storedTree = localStorage.getItem('g_rescue_tree_v1');
                    this.tree = storedTree ? JSON.parse(storedTree) : INITIAL_TREE;
                }

                this.data.forEach(q => { if (typeof q.variant === 'undefined') { q.variant = q.isVariant ? 1 : 0; delete q.isVariant; } });
                if(!localStorage.getItem('g_rescue_v6')) localStorage.setItem('g_rescue_v6', JSON.stringify(this.data));
                
                this.detectSeason();
                this.loadDarkMode();
                this.renderSeasonalEffects();
                this.goLanding();
            },

            detectSeason() {
                const month = new Date().getMonth() + 1;
                if (month >= 1 && month <= 3) this.season = 'spring';
                else if (month >= 4 && month <= 6) this.season = 'summer';
                else if (month >= 7 && month <= 9) this.season = 'autumn';
                else this.season = 'winter';
                document.body.classList.add(`season-${this.season}`);
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-btn').innerHTML = '<i class="fa-solid fa-sun text-yellow-400"></i>';
                    document.getElementById('dark-mode-btn').classList.replace('bg-slate-100', 'bg-slate-700');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('dark-mode-btn').innerHTML = '<i class="fa-solid fa-moon"></i>';
                    document.getElementById('dark-mode-btn').classList.replace('bg-slate-700', 'bg-slate-100');
                }
                localStorage.setItem('g_rescue_dark_mode', this.isDarkMode);
            },
            loadDarkMode() {
                const saved = localStorage.getItem('g_rescue_dark_mode');
                if (saved === 'true') {
                    this.isDarkMode = true;
                    document.body.classList.add('dark-mode');
                }
            },
            renderSeasonalEffects() {
                const container = document.getElementById('falling-container');
                let icon = ''; let count = 15; let colors = [];
                if (this.season === 'spring') { icon = 'üå∏'; colors = ['#fbcfe8', '#f472b6']; count = 20; }
                else if (this.season === 'summer') { icon = 'üå∫'; colors = ['#fecaca', '#ef4444']; count = 15; }
                else if (this.season === 'autumn') { icon = 'üçÅ'; colors = ['#fdba74', '#ea580c']; count = 15; }
                else { icon = '‚ùÑÔ∏è'; colors = ['#bae6fd', '#fff']; count = 30; }
                let html = '';
                for (let i = 0; i < count; i++) {
                    const left = Math.random() * 100; const delay = Math.random() * 5; const duration = 5 + Math.random() * 5; const size = 10 + Math.random() * 15;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const styleColor = this.season === 'winter' ? '' : `color: ${color};`;
                    html += `<div class="falling-item" style="left: ${left}%; animation-delay: ${delay}s; animation-duration: ${duration}s; font-size: ${size}px; ${styleColor}">${icon}</div>`;
                }
                container.innerHTML = html;
            },

            goLanding() {
                this.userRole = null;
                const quotes = [
                    "H·ªçc ƒëi ch·ªù chi! üöÄ",
                    "√Åp l·ª±c t·∫°o kim c∆∞∆°ng, nh∆∞ng ƒë·ª´ng ƒë·ªÉ √°p l·ª±c t·∫°o... 'tr·∫ßm k·∫Ωm' nha! üíé",
                    "Sai th√¨ s·ª≠a, ch·ª≠a th√¨... √† nh·∫ßm, sai th√¨ v√†o Tr·∫°m C·ª©u H·ªô! üõ†Ô∏è",
                    "Top 1 server To√°n h·ªçc b·∫Øt ƒë·∫ßu t·ª´ vi·ªác click b√†i b√™n tr√°i. üëá",
                    "Kh√¥ng l√†m m√† ƒë√≤i c√≥ ƒÉn th√¨ ch·ªâ c√≥... l√†m b√†i t·∫≠p G-Rescue th√¥i! üçö"
                ];
                const quote = quotes[Math.floor(Math.random() * quotes.length)];

                document.getElementById('app-container').innerHTML = `
                    <div class="max-w-4xl mx-auto py-12 fade-in">
                        <div class="text-center mb-10"><h2 class="text-4xl font-bold text-slate-800 mb-2 tracking-tight">Ch√†o m·ª´ng ƒë·∫øn v·ªõi G-RESCUE</h2><p class="text-slate-500">H·ªá th·ªëng gia s∆∞ AI th√¥ng minh & Qu·∫£n l√Ω ng√¢n h√†ng ƒë·ªÅ</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            <div onclick="app.login('student')" class="role-card bg-white p-8 rounded-2xl shadow-lg border border-blue-50 cursor-pointer text-center group"><div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-600 transition"><i class="fa-solid fa-user-graduate text-3xl text-blue-600 group-hover:text-white"></i></div><h3 class="text-xl font-bold text-slate-800">H·ªçc sinh</h3><p class="text-sm text-slate-500 mt-2">Luy·ªán ƒë·ªÅ, tra c·ª©u, h·ªçc s√¢u v·ªõi AI Mentor Gen Z.</p></div>
                            <div onclick="app.login('admin')" class="role-card bg-white p-8 rounded-2xl shadow-lg border border-amber-50 cursor-pointer text-center group"><div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-amber-600 transition"><i class="fa-solid fa-chalkboard-user text-3xl text-amber-600 group-hover:text-white"></i></div><h3 class="text-xl font-bold text-slate-800">Admin</h3><p class="text-sm text-slate-500 mt-2">Qu·∫£n l√Ω c·∫•u tr√∫c, ng√¢n h√†ng c√¢u h·ªèi & Xu·∫•t PDF.</p></div>
                        </div>
                    </div>`;
            },
            login(role) {
                const theme = role === 'student' ? 'blue' : 'amber';
                document.getElementById('app-container').innerHTML = `
                    <div class="max-w-md mx-auto fade-in mt-10">
                        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100"><h2 class="text-2xl font-bold text-center text-slate-800 mb-6">ƒêƒÉng nh·∫≠p ${role === 'student' ? 'H·ªçc sinh' : 'Admin'}</h2><div class="space-y-4"><input type="text" id="u" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-${theme}-500 outline-none" placeholder="T√™n ƒëƒÉng nh·∫≠p"><input type="password" id="p" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-${theme}-500 outline-none" placeholder="M·∫≠t kh·∫©u"><button onclick="app.auth('${role}')" class="w-full bg-${theme}-600 text-white py-3 rounded-lg font-bold hover:bg-${theme}-700 transition">V√†o h·ªá th·ªëng</button><button onclick="app.goLanding()" class="w-full text-slate-500 text-sm mt-2 hover:underline">Quay l·∫°i</button></div></div>
                    </div>`;
            },
            auth(role) {
                const u = document.getElementById('u').value.trim(); const p = document.getElementById('p').value.trim();
                if ((role==='admin' && u==='admin' && p==='123') || (role==='student' && u==='hocsinh' && p==='123')) { this.userRole = role; role === 'admin' ? this.renderAdmin() : this.renderStudent(); } else alert("Sai th√¥ng tin! (Demo: admin/123 ho·∫∑c hocsinh/123)");
            },

            // --- ADMIN MODULE ---
            handleSearch(val) { this.searchTerm = val.trim(); this.renderAdmin(); },
            renderAdmin() {
                const grades = Object.keys(this.tree);
                let list = [...this.data].reverse();
                if (this.searchTerm) { list = list.filter(q => q.id.toString().includes(this.searchTerm)); } 
                else {
                    if (this.adminFilter.grade) list = list.filter(q => q.grade === this.adminFilter.grade);
                    if (this.adminFilter.chapter) list = list.filter(q => q.chapter === this.adminFilter.chapter);
                    if (this.adminFilter.lesson) list = list.filter(q => q.lesson === this.adminFilter.lesson);
                }
                const isEditing = !!this.editId;
                const formClass = isEditing ? 'bg-yellow-50 border-yellow-400 ring-2 ring-yellow-200' : 'bg-slate-50 border-slate-200';
                const formHeader = isEditing ? `<i class="fa-solid fa-pen-to-square text-yellow-600"></i> ƒêang s·ª≠a c√¢u: <span class="font-mono text-blue-600">#${this.editId}</span>` : `<label class="text-xs font-bold text-slate-500 uppercase">V·ªã tr√≠ b√†i h·ªçc (L·∫•y t·ª´ C·∫•u tr√∫c)</label>`;
                const tabNav = `<div class="flex space-x-2 mb-6 border-b"><button onclick="app.switchAdminTab('question')" class="px-4 py-2 font-bold border-b-2 transition ${this.adminTab==='question'?'border-blue-600 text-blue-600':'border-transparent text-slate-500 hover:text-slate-700'}"><i class="fa-solid fa-list-check mr-2"></i>Qu·∫£n l√Ω C√¢u h·ªèi</button><button onclick="app.switchAdminTab('structure')" class="px-4 py-2 font-bold border-b-2 transition ${this.adminTab==='structure'?'border-amber-600 text-amber-600':'border-transparent text-slate-500 hover:text-slate-700'}"><i class="fa-solid fa-folder-tree mr-2"></i>Qu·∫£n l√Ω C·∫•u tr√∫c</button></div>`;
                const structureUI = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in"><div class="bg-slate-50 p-5 rounded-xl border border-slate-200"><h3 class="font-bold text-slate-700 mb-3"><i class="fa-solid fa-layer-group text-blue-500"></i> Th√™m Kh·ªëi M·ªõi</h3><div class="flex gap-2 mb-4"><input id="new-grade-name" type="text" class="flex-1 border p-2 rounded text-sm focus:outline-blue-500" placeholder="VD: Kh·ªëi 13"><button onclick="app.addNewGrade()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><i class="fa-solid fa-plus"></i></button></div><div class="text-xs text-slate-400">Danh s√°ch hi·ªán t·∫°i: ${grades.join(', ')}</div></div><div class="bg-slate-50 p-5 rounded-xl border border-slate-200"><h3 class="font-bold text-slate-700 mb-3"><i class="fa-solid fa-folder-open text-amber-500"></i> Th√™m Ch∆∞∆°ng</h3><select id="struct-g-sel" onchange="app.setStructG(this.value)" class="w-full border p-2 rounded text-sm mb-2 focus:outline-amber-500"><option value="">-- Ch·ªçn Kh·ªëi c·∫ßn th√™m --</option>${grades.map(g => `<option value="${g}" ${this.structSel.g===g?'selected':''}>${g}</option>`).join('')}</select><div class="flex gap-2"><input id="new-chapter-name" type="text" class="flex-1 border p-2 rounded text-sm focus:outline-amber-500" placeholder="T√™n ch∆∞∆°ng m·ªõi..."><button onclick="app.addNewChapter()" class="bg-amber-600 text-white px-3 rounded hover:bg-amber-700"><i class="fa-solid fa-plus"></i></button></div></div><div class="bg-slate-50 p-5 rounded-xl border border-slate-200"><h3 class="font-bold text-slate-700 mb-3"><i class="fa-solid fa-file-pen text-green-500"></i> Th√™m B√†i H·ªçc</h3><select id="struct-g-sel-lesson" onchange="app.uiUpdateStructChapters(this.value)" class="w-full border p-2 rounded text-sm mb-2 focus:outline-green-500"><option value="">-- Ch·ªçn Kh·ªëi --</option>${grades.map(g => `<option value="${g}">${g}</option>`).join('')}</select><select id="struct-c-sel-lesson" class="w-full border p-2 rounded text-sm mb-2 focus:outline-green-500"><option value="">-- Ch·ªçn Ch∆∞∆°ng tr∆∞·ªõc --</option></select><div class="flex gap-2"><input id="new-lesson-name" type="text" class="flex-1 border p-2 rounded text-sm focus:outline-green-500" placeholder="T√™n b√†i h·ªçc m·ªõi..."><button onclick="app.addNewLesson()" class="bg-green-600 text-white px-3 rounded hover:bg-green-700"><i class="fa-solid fa-plus"></i></button></div></div></div><div class="mt-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">C√¢y C·∫•u Tr√∫c Hi·ªán T·∫°i (X√≥a t·∫°i ƒë√¢y)</h3><button onclick="app.manualSaveTree()" class="text-xs bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 font-bold"><i class="fa-solid fa-floppy-disk mr-2"></i>L∆∞u C·∫•u tr√∫c</button></div><div class="h-64 overflow-y-auto custom-scrollbar text-sm space-y-4 pr-2">${this.renderTreePreview()}</div></div>`;
                const variantOptions = `<option value="0">C√¢u G·ªëc</option>` + Array.from({length:10}, (_,i)=>`<option value="${i+1}">Bi·∫øn th·ªÉ ${i+1}</option>`).join('');
                const manualUI = `<div class="space-y-3 mb-4"><div class="grid grid-cols-2 gap-2"><select id="adm-type" class="border p-2 rounded text-sm" onchange="app.renderManualOptionsUI()"><option value="mcq">Tr·∫Øc nghi·ªám</option><option value="short">ƒêi·ªÅn khuy·∫øt</option><option value="tf">ƒê√∫ng/Sai</option></select><select id="adm-lvl" class="border p-2 rounded text-sm"><option value="1">M·ª©c 1 (Bi·∫øt)</option><option value="2">M·ª©c 2 (Hi·ªÉu)</option><option value="3">M·ª©c 3 (V·∫≠n d·ª•ng)</option></select></div><select id="adm-var" class="w-full border p-2 rounded text-sm">${variantOptions}</select><textarea id="adm-content" class="w-full border p-3 rounded h-24 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="N·ªôi dung c√¢u h·ªèi (LaTeX: $...$, B·∫£ng: \\begin{tikzpicture}...)"></textarea><div id="manual-options-area"></div></div><div class="bg-amber-50 p-3 rounded border border-amber-100 space-y-2"><label class="text-xs font-bold text-amber-700 uppercase"><i class="fa-solid fa-robot"></i> D·ªØ li·ªáu Gia s∆∞ AI</label><textarea id="adm-theory" class="w-full border p-2 rounded text-sm h-16" placeholder="G·ª£i √Ω / L√Ω thuy·∫øt"></textarea><textarea id="adm-steps" class="w-full border p-2 rounded text-sm h-16" placeholder="C√°c b∆∞·ªõc gi·∫£i (xu·ªëng d√≤ng)"></textarea><textarea id="adm-sol" class="w-full border p-2 rounded text-sm h-20" placeholder="L·ªùi gi·∫£i chi ti·∫øt"></textarea></div><div class="flex gap-2 mt-4"><button onclick="app.saveQuestion()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow"><i class="fa-solid fa-save"></i> ${this.editId ? 'C·∫≠p nh·∫≠t' : 'L∆∞u c√¢u h·ªèi'}</button>${this.editId ? '<button onclick="app.cancelEdit()" class="px-4 bg-gray-200 rounded hover:bg-gray-300">Hu·ª∑</button>' : ''}</div>`;
                const jsonUI = `<div class="space-y-4 animate-fade-in"><div class="bg-green-50 p-4 rounded-xl border border-green-200"><h3 class="font-bold text-green-800 mb-2"><i class="fa-solid fa-file-code mr-2"></i> Nh·∫≠p d·ªØ li·ªáu t·ª´ file JSON</h3><p class="text-sm text-green-700 mb-4">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng xu·∫•t t·ª´ h·ªá th·ªëng G-RESCUE. D√πng ƒë·ªÉ sao l∆∞u ho·∫∑c chuy·ªÉn d·ªØ li·ªáu.</p><input type="file" id="json-input" accept=".json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"/><button onclick="app.importJSONFile()" class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg font-bold shadow hover:bg-green-700 transition"><i class="fa-solid fa-upload mr-2"></i> T·∫£i l√™n & Nh·∫≠p</button></div></div>`;
                const wordUI = `<div class="space-y-4"><div class="bg-indigo-50 p-3 rounded border border-indigo-100 text-xs text-indigo-700 mb-2"><b>ƒê·ªãnh d·∫°ng:</b> .docx, b·∫Øt ƒë·∫ßu "C√¢u 1:", ƒë√°p √°n "A.", "B.", l·ªùi gi·∫£i "L·ªùi gi·∫£i".</div><div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-600 whitespace-nowrap">Lo·∫°i c√¢u h·ªèi:</span><select id="word-type" class="border p-2 rounded text-sm w-full"><option value="auto">‚ú® T·ª± ƒë·ªông nh·∫≠n di·ªán (M·∫∑c ƒë·ªãnh)</option><option value="mcq">Tr·∫Øc nghi·ªám (4 ƒë√°p √°n)</option><option value="tf">ƒê√∫ng / Sai</option><option value="short">Tr·∫£ l·ªùi ng·∫Øn</option></select></div><div class="grid grid-cols-2 gap-2"><select id="word-lvl" class="border p-2 rounded text-sm"><option value="1">M·ª©c 1 (Bi·∫øt)</option><option value="2">M·ª©c 2 (Hi·ªÉu)</option><option value="3">M·ª©c 3 (V·∫≠n d·ª•ng)</option></select><select id="word-var" class="border p-2 rounded text-sm">${variantOptions}</select></div><div class="flex items-center gap-4"><label class="cursor-pointer bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-bold shadow flex items-center gap-2"><i class="fa-solid fa-file-word"></i> Nh·∫≠p t·ª´ Word (.docx)<input type="file" onchange="app.handleWordUpload(event)" class="hidden" accept=".docx"></label><span id="word-status" class="text-sm text-slate-500 italic"></span></div><div id="word-preview" class="space-y-4 max-h-[600px] overflow-y-auto p-2 border rounded bg-slate-50 hidden"></div><button id="btn-save-word" onclick="app.saveWordDrafts()" class="hidden w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold shadow"><i class="fa-solid fa-file-import"></i> L∆∞u v√†o Ng√¢n h√†ng</button></div>`;
                const questionUI = `<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in"><div class="lg:col-span-5 space-y-4"><div id="question-form-container" class="${formClass} p-4 rounded-xl border transition-all duration-300"><div class="mb-4 space-y-2"><h3 class="mb-2 text-sm">${formHeader}</h3><select id="adm-g" onchange="app.setG(this.value)" class="w-full border p-2 rounded text-sm"><option value="">-- Ch·ªçn Kh·ªëi --</option>${grades.map(g => `<option value="${g}" ${this.sel.g===g?'selected':''}>${g}</option>`).join('')}</select><select id="adm-c" onchange="app.setC(this.value)" class="w-full border p-2 rounded text-sm"><option value="">-- Ch·ªçn Ch∆∞∆°ng --</option></select><select id="adm-l" onchange="app.setL(this.value)" class="w-full border p-2 rounded text-sm"><option value="">-- Ch·ªçn B√†i --</option></select></div><div class="flex border-b mb-4"><button onclick="app.setMode('manual')" class="px-4 py-2 text-sm font-bold ${this.adminMode==='manual'?'border-b-2 border-blue-600 text-blue-600':'text-slate-500'}">Th·ªß c√¥ng</button><button onclick="app.setMode('json')" class="px-4 py-2 text-sm font-bold ${this.adminMode==='json'?'border-b-2 border-green-600 text-green-600':'text-slate-500'}">Nh·∫≠p JSON</button><button onclick="app.setMode('word')" class="px-4 py-2 text-sm font-bold ${this.adminMode==='word'?'border-b-2 border-indigo-600 text-indigo-600':'text-slate-500'}">Word</button></div>${this.adminMode==='manual' ? manualUI : (this.adminMode==='json' ? jsonUI : wordUI)}</div></div><div class="lg:col-span-7"><div class="flex flex-col gap-3 mb-3"><div class="flex justify-between items-center"><h3 class="font-bold text-slate-700">Ng√¢n h√†ng c√¢u h·ªèi (${list.length})</h3><div class="bg-white p-1 rounded border flex gap-2"><button onclick="app.exportPDF()" class="text-xs bg-purple-600 text-white px-3 py-1 rounded shadow hover:bg-purple-700 flex items-center"><i class="fa-solid fa-print mr-1"></i> Xu·∫•t PDF (In)</button><button onclick="app.clearAllData()" class="text-xs bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700"><i class="fa-solid fa-trash-can mr-1"></i> Reset</button><button onclick="app.saveFullHTML()" class="text-xs bg-green-600 text-white px-3 py-1 rounded shadow hover:bg-green-700"><i class="fa-solid fa-download mr-1"></i> HTML</button><button onclick="app.exportJSON()" class="text-xs bg-orange-600 text-white px-3 py-1 rounded shadow hover:bg-orange-700"><i class="fa-solid fa-file-code mr-1"></i> JSON</button><button onclick="app.saveToCode()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded shadow hover:bg-indigo-700"><i class="fa-solid fa-floppy-disk mr-1"></i> L∆∞u Data</button></div></div><div class="flex gap-2"><div class="relative flex-grow"><i class="fa-solid fa-magnifying-glass absolute left-3 top-2 text-slate-400 text-sm"></i><input type="text" id="search-id" value="${this.searchTerm}" onkeyup="app.handleSearch(this.value)" placeholder="T√¨m nhanh ID c√¢u h·ªèi..." class="w-full pl-8 pr-3 py-1.5 border rounded text-sm focus:outline-blue-500 focus:border-blue-500 shadow-sm"></div><div class="bg-white p-1 rounded border flex gap-1 flex-shrink-0"><select id="filt-g" onchange="app.setFilter('grade',this.value)" class="p-1 text-xs outline-none bg-transparent max-w-[100px]"><option value="">T·∫•t c·∫£ Kh·ªëi</option>${grades.map(g=>`<option value="${g}">${g}</option>`).join('')}</select></div></div></div><div class="h-[800px] overflow-y-auto custom-scrollbar space-y-3 pr-2">${list.map(q => `<div class="border p-3 rounded-lg bg-white relative hover:shadow-md transition group"><div class="flex gap-2 mb-1"><span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 rounded">#${q.id}</span><span class="text-[10px] bg-gray-100 px-2 rounded truncate max-w-[200px]" title="${q.lesson}">${q.lesson}</span><span class="text-[10px] ${q.variant===0?'bg-green-100 text-green-700':'bg-purple-100 text-purple-700'} px-2 rounded">${q.variant===0?'G·ªëc':`BT ${q.variant}`}</span></div><div class="text-sm line-clamp-2 mb-2 word-content">${q.content}</div><div class="flex gap-2 text-xs mt-3 border-t pt-2"><button onclick="app.editQ('${q.id}')" class="bg-blue-50 text-blue-600 border border-blue-200 px-3 py-1 rounded hover:bg-blue-100 font-medium">S·ª≠a</button><button onclick="app.cloneToVariant('${q.id}')" class="bg-purple-50 text-purple-600 border border-purple-200 px-3 py-1 rounded hover:bg-purple-100 font-medium">T·∫°o bi·∫øn th·ªÉ</button><button onclick="app.delQ('${q.id}')" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded hover:bg-red-100 font-medium">Xo√°</button><button onclick="app.viewQuestionDetail('${q.id}')" class="bg-slate-50 text-slate-600 border border-slate-200 px-3 py-1 rounded hover:bg-slate-100 font-medium"><i class="fa-solid fa-eye"></i> Xem</button></div></div>`).join('')}${list.length === 0 ? '<div class="text-center text-slate-400 py-10 italic">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o.</div>' : ''}</div></div></div>`;
                
                document.getElementById('app-container').innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 fade-in w-full max-w-7xl mx-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">Trang Qu·∫£n Tr·ªã</h2><button onclick="app.goLanding()" class="text-red-500 text-sm hover:underline"><i class="fa-solid fa-right-from-bracket"></i> Tho√°t</button></div>${tabNav}${this.adminTab === 'question' ? questionUI : structureUI}</div>`;

                if(this.adminTab === 'question') {
                    this.uiUpdateChapters();
                    this.renderManualOptionsUI();
                    if(this.editId) this.populateEditForm();
                    if (this.adminMode === 'word' && this.wordDrafts.length > 0) this.renderWordPreview();
                    const searchInput = document.getElementById('search-id'); if(searchInput && this.searchTerm) { searchInput.focus(); const len = searchInput.value.length; searchInput.setSelectionRange(len, len); }
                }
            },
            
            renderManualOptionsUI() {
                const type = document.getElementById('adm-type') ? document.getElementById('adm-type').value : 'mcq';
                const container = document.getElementById('manual-options-area');
                if(!container) return;
                if(type === 'mcq') {
                    container.innerHTML = `<textarea id="adm-opts" class="w-full border p-3 rounded h-16 text-sm" placeholder="ƒê√°p √°n c√°ch nhau b·ªüi d·∫•u | (VD: A|B|C|D)"></textarea><input id="adm-correct" class="w-full border p-2 rounded text-sm mt-2" placeholder="ƒê√°p √°n ƒë√∫ng (Index 0-3 ho·∫∑c text)">`;
                } else if(type === 'tf') {
                    container.innerHTML = `<div class="space-y-2 border p-2 rounded bg-slate-50"><div class="text-xs font-bold">C√°c √Ω ƒë√∫ng/sai:</div><div class="flex gap-2 items-center"><input class="border p-1 w-full text-sm" id="tf-opt-0" placeholder="√ù 1"><select class="border p-1 text-sm" id="tf-val-0"><option value="0">ƒê√∫ng</option><option value="1">Sai</option></select></div><div class="flex gap-2 items-center"><input class="border p-1 w-full text-sm" id="tf-opt-1" placeholder="√ù 2"><select class="border p-1 text-sm" id="tf-val-1"><option value="0">ƒê√∫ng</option><option value="1">Sai</option></select></div><div class="flex gap-2 items-center"><input class="border p-1 w-full text-sm" id="tf-opt-2" placeholder="√ù 3"><select class="border p-1 text-sm" id="tf-val-2"><option value="0">ƒê√∫ng</option><option value="1">Sai</option></select></div><div class="flex gap-2 items-center"><input class="border p-1 w-full text-sm" id="tf-opt-3" placeholder="√ù 4"><select class="border p-1 text-sm" id="tf-val-3"><option value="0">ƒê√∫ng</option><option value="1">Sai</option></select></div></div><input type="hidden" id="adm-opts"><input type="hidden" id="adm-correct">`;
                } else {
                    container.innerHTML = `<input id="adm-correct" class="w-full border p-2 rounded text-sm" placeholder="Nh·∫≠p ƒë√°p √°n ƒë√∫ng (S·ªë ho·∫∑c ch·ªØ)"><input type="hidden" id="adm-opts">`;
                }
            },

            async exportPDF() {
                let list = [...this.data];
                if (this.searchTerm) list = list.filter(q => q.id.toString().includes(this.searchTerm));
                else { 
                    if (this.adminFilter.grade) list = list.filter(q => q.grade === this.adminFilter.grade);
                    if (this.adminFilter.chapter) list = list.filter(q => q.chapter === this.adminFilter.chapter); 
                    if (this.adminFilter.lesson) list = list.filter(q => q.lesson === this.adminFilter.lesson);
                }
                if(list.length === 0) return alert("Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ xu·∫•t!");
                document.getElementById('export-processing').classList.remove('hidden');
                let contentHTML = '';
                for(let i=0; i<list.length; i++) {
                    const q = list[i];
                    const processedContent = await this.renderContent(q.content);
                    contentHTML += `<div class="question-item"><div class="q-header"><strong>C√¢u ${i+1}</strong> <span class="q-id">[#${q.id}]</span><span class="q-meta">(${q.grade} - ${q.lesson})</span></div><div class="q-content">${processedContent}</div><div class="q-options">${q.options && q.type==='mcq' ? q.options.map((o, idx) => `<div class="q-option"><span class="opt-label">${String.fromCharCode(65+idx)}.</span> ${o}</div>`).join('') : ''}</div><div class="q-solution"><strong>L·ªùi gi·∫£i:</strong> ${q.solution}</div></div>`;
                }
                document.getElementById('export-processing').classList.add('hidden');
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>ƒê·ªÅ xu·∫•t t·ª´ G-RESCUE</title><script>MathJax = { tex: { inlineMath: [['$', '$'], ['\\\\(', '\\\\)']] }, svg: { fontCache: 'global' }, startup: { ready: () => MathJax.startup.defaultReady() } };<\/script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script><style>body { font-family: 'Times New Roman', serif; padding: 20px; color: #000; font-size: 14px; } .question-item { margin-bottom: 20px; page-break-inside: avoid; border-bottom: 1px dashed #ccc; padding-bottom: 15px; } .q-header { margin-bottom: 5px; font-size: 1.1em; display: flex; align-items: center; } .q-id { color: #4f46e5; font-family: monospace; font-size: 0.85em; margin-left: 8px; margin-right: 8px; background: #eef2ff; padding: 2px 4px; border-radius: 4px; border: 1px solid #c7d2fe; } .q-meta { font-weight: normal; font-size: 0.8em; color: #666; font-style: italic; } .q-content { margin-bottom: 10px; } .q-content img { max-width: 100%; display: block; margin: 10px auto; } .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; } .q-option { } .opt-label { font-weight: bold; } .q-solution { background: #f9f9f9; padding: 10px; font-size: 0.9em; border: 1px solid #eee; }</style></head><body><h1 style="text-align: center; margin-bottom: 30px;">DANH S√ÅCH C√ÇU H·ªéI √îN T·∫¨P</h1>${contentHTML}<script>setTimeout(() => { window.print(); }, 1500);<\/script></body></html>`); printWindow.document.close();
            },

            switchAdminTab(tab) { this.adminTab = tab; this.renderAdmin(); },
            setStructG(val) { this.structSel.g = val; this.renderAdmin(); },
            renderTreePreview() {
                let html = '';
                for(const g in this.tree) {
                    html += `<div class="mb-2 group/g"><div class="flex items-center gap-2"><span class="font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded text-sm">${g}</span><i onclick="app.deleteGrade('${g}')" class="fa-solid fa-trash-can text-xs delete-btn" title="X√≥a Kh·ªëi"></i></div><div class="pl-4 border-l-2 border-slate-100 ml-2 mt-1 space-y-2">`;
                    const chapters = this.tree[g]; if(Object.keys(chapters).length === 0) html += `<div class="text-slate-400 italic text-xs pl-2">Ch∆∞a c√≥ ch∆∞∆°ng n√†o</div>`;
                    for(const c in chapters) {
                        html += `<div><div class="flex items-center gap-2"><span class="font-semibold text-amber-700 text-sm">${c}</span><i onclick="app.deleteChapter('${g}', '${c}')" class="fa-solid fa-trash-can text-[10px] delete-btn" title="X√≥a Ch∆∞∆°ng"></i></div><div class="pl-4 text-slate-500 text-xs mt-1 grid grid-cols-2 gap-1">`;
                        if(chapters[c].length === 0) html += `<span class="italic text-slate-300">Ch∆∞a c√≥ b√†i n√†o</span>`;
                        chapters[c].forEach(l => html += `<span class="bg-slate-50 p-1 rounded border border-slate-100 truncate hover:bg-slate-100 flex justify-between items-center group/l" title="${l}"><span class="truncate"><i class="fa-solid fa-file text-[8px] mr-1 text-slate-400"></i>${l}</span> <i onclick="app.deleteLesson('${g}', '${c}', '${l}')" class="fa-solid fa-xmark ml-1 text-[10px] delete-btn"></i></span>`);
                        html += `</div></div>`;
                    }
                    html += `</div></div>`;
                }
                return html;
            },
            saveTree() { localStorage.setItem('g_rescue_tree_v1', JSON.stringify(this.tree)); this.renderAdmin(); },
            manualSaveTree() { localStorage.setItem('g_rescue_tree_v1', JSON.stringify(this.tree)); alert("ƒê√£ l∆∞u c·∫•u tr√∫c th√†nh c√¥ng!"); this.renderAdmin(); },
            addNewGrade() { const name = document.getElementById('new-grade-name').value.trim(); if(!name) return alert("Nh·∫≠p t√™n kh·ªëi!"); if(this.tree[name]) return alert("Kh·ªëi n√†y ƒë√£ t·ªìn t·∫°i!"); this.tree[name] = {}; this.saveTree(); },
            deleteGrade(g) { if(confirm(`X√≥a to√†n b·ªô ${g} v√† c√°c ch∆∞∆°ng b√™n trong?`)) { delete this.tree[g]; this.saveTree(); } },
            addNewChapter() { const g = document.getElementById('struct-g-sel').value; const name = document.getElementById('new-chapter-name').value.trim(); if(!g) return alert("Ch·ªçn Kh·ªëi tr∆∞·ªõc!"); if(!name) return alert("Nh·∫≠p t√™n ch∆∞∆°ng!"); if(this.tree[g][name]) return alert("Ch∆∞∆°ng n√†y ƒë√£ t·ªìn t·∫°i!"); this.tree[g][name] = []; this.saveTree(); },
            deleteChapter(g, c) { if(confirm(`X√≥a ${c} v√† c√°c b√†i h·ªçc b√™n trong?`)) { delete this.tree[g][c]; this.saveTree(); } },
            addNewLesson() { const g = document.getElementById('struct-g-sel-lesson').value; const c = document.getElementById('struct-c-sel-lesson').value; const name = document.getElementById('new-lesson-name').value.trim(); if(!g || !c) return alert("Ch·ªçn Kh·ªëi v√† Ch∆∞∆°ng!"); if(!name) return alert("Nh·∫≠p t√™n b√†i!"); if(this.tree[g][c].includes(name)) return alert("B√†i n√†y ƒë√£ t·ªìn t·∫°i!"); this.tree[g][c].push(name); this.saveTree(); },
            deleteLesson(g, c, l) { if(confirm(`X√≥a b√†i h·ªçc: ${l}?`)) { this.tree[g][c] = this.tree[g][c].filter(item => item !== l); this.saveTree(); } },
            uiUpdateStructChapters(grade) { const cSel = document.getElementById('struct-c-sel-lesson'); if(!cSel) return; let html = '<option value="">-- Ch·ªçn Ch∆∞∆°ng --</option>'; if(grade && this.tree[grade]) { Object.keys(this.tree[grade]).forEach(c => html += `<option value="${c}">${c}</option>`); } cSel.innerHTML = html; },

            setMode(m) { this.adminMode = m; this.renderAdmin(); },
            setFilter(k, v) { this.adminFilter[k] = v; if(k==='grade'){this.adminFilter.chapter='';this.adminFilter.lesson='';} if(k==='chapter')this.adminFilter.lesson=''; this.renderAdmin(); },
            setG(v) { this.sel.g = v; this.sel.c = ''; this.sel.l = ''; this.uiUpdateChapters(); },
            setC(v) { this.sel.c = v; this.sel.l = ''; this.uiUpdateLessons(); },
            setL(v) { this.sel.l = v; },
            uiUpdateChapters() { const c = document.getElementById('adm-c'); if(!c) return; const val = this.sel.g; let html = '<option value="">-- Ch·ªçn Ch∆∞∆°ng --</option>'; if(val && this.tree[val]) html += Object.keys(this.tree[val]).map(k => `<option value="${k}" ${this.sel.c===k?'selected':''}>${k}</option>`).join(''); c.innerHTML = html; this.uiUpdateLessons(); },
            uiUpdateLessons() { const l = document.getElementById('adm-l'); if(!l) return; const gv = this.sel.g; const cv = this.sel.c; let html = '<option value="">-- Ch·ªçn B√†i --</option>'; if(gv && cv && this.tree[gv][cv]) html += this.tree[gv][cv].map(k => `<option value="${k}" ${this.sel.l===k?'selected':''}>${k}</option>`).join(''); l.innerHTML = html; },
            saveQuestion() {
                const type = document.getElementById('adm-type').value;
                let options = [], correct = "";
                if(type === 'mcq') {
                    options = document.getElementById('adm-opts').value.split('|').map(s=>s.trim());
                    correct = document.getElementById('adm-correct').value.trim();
                } else if(type === 'tf') {
                    options = [ document.getElementById('tf-opt-0').value, document.getElementById('tf-opt-1').value, document.getElementById('tf-opt-2').value, document.getElementById('tf-opt-3').value ];
                    correct = [ document.getElementById('tf-val-0').value, document.getElementById('tf-val-1').value, document.getElementById('tf-val-2').value, document.getElementById('tf-val-3').value ].join('|');
                } else {
                    correct = document.getElementById('adm-correct').value.trim();
                }
                let baseId;

if (this.editId) {
    baseId = this.editId;
} else {
    const prefix = this.generateBasePrefix(
        this.sel.g,
        this.sel.c,
        this.sel.l,
        type,
        parseInt(document.getElementById('adm-lvl').value)
    );
    const nextIndex = this.getNextIndex(prefix) + 1;
    baseId = `${prefix}_${String(nextIndex).padStart(2, '0')}`;
}
                const q = { id: baseId || Date.now(), grade: this.sel.g, chapter: this.sel.c, lesson: this.sel.l, type: type, level: parseInt(document.getElementById('adm-lvl').value), variant: parseInt(document.getElementById('adm-var').value), content: document.getElementById('adm-content').value.trim(), options: options, correct: correct, theory: document.getElementById('adm-theory').value, steps: document.getElementById('adm-steps').value.split('\n'), solution: document.getElementById('adm-sol').value };
                if(!q.grade || !q.lesson || !q.content) return alert("Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc!");
                if(this.editId) { const idx = this.data.findIndex(i => i.id == this.editId); if(idx!==-1) { this.data[idx] = q; alert("ƒê√£ c·∫≠p nh·∫≠t!"); } this.editId = null; } else { this.data.push(q); alert("ƒê√£ th√™m m·ªõi!"); }
                localStorage.setItem('g_rescue_v6', JSON.stringify(this.data)); this.renderAdmin();
            },
            editQ(id) { 
                const q = this.data.find(i => i.id == id); if(!q) return; this.editId = id; this.sel.g = q.grade; this.sel.c = q.chapter; this.sel.l = q.lesson; this.setMode('manual'); 
                document.getElementById('question-form-container').scrollIntoView({ behavior: 'smooth' });
            },
            populateEditForm() { 
                const q = this.data.find(i => i.id == this.editId); if(!q) return; 
                document.getElementById('adm-type').value = q.type; 
                this.renderManualOptionsUI(); // Render inputs based on type
                document.getElementById('adm-lvl').value = q.level; document.getElementById('adm-var').value = q.variant || 0; document.getElementById('adm-content').value = q.content; 
                
                if(q.type === 'mcq') {
                    document.getElementById('adm-opts').value = q.options.join('|');
                    document.getElementById('adm-correct').value = q.correct;
                } else if(q.type === 'tf') {
                    const corrects = q.correct.split('|');
                    q.options.forEach((o, i) => { document.getElementById(`tf-opt-${i}`).value = o; document.getElementById(`tf-val-${i}`).value = corrects[i]; });
                } else {
                    document.getElementById('adm-correct').value = q.correct;
                }
                
                document.getElementById('adm-theory').value = q.theory || ''; document.getElementById('adm-steps').value = (q.steps||[]).join('\n'); document.getElementById('adm-sol').value = q.solution || ''; document.getElementById('adm-g').value = q.grade; this.uiUpdateChapters(); document.getElementById('adm-c').value = q.chapter; this.uiUpdateLessons(); document.getElementById('adm-l').value = q.lesson; 
            },
// --- 3. S·ª¨A H√ÄM T·∫†O BI·∫æN TH·ªÇ (cloneToVariant) ---
cloneToVariant(originalId) {
    const q = this.data.find(x => x.id === originalId);
    if (!q) return;

    // Ch·ªâ cho ph√©p t·∫°o bi·∫øn th·ªÉ t·ª´ c√¢u g·ªëc (variant = 0) ho·∫∑c t·ª´ bi·∫øn th·ªÉ kh√°c (nh∆∞ng v·∫´n l·∫•y g·ªëc l√†m chu·∫©n)
    // N·∫øu originalId ƒë√£ l√† bi·∫øn th·ªÉ (vd: ..._V1), ta ph·∫£i t√¨m v·ªÅ ID g·ªëc c·ªßa n√≥
    let baseId = originalId;
    if (originalId.toString().includes('_V')) {
        baseId = originalId.split('_V')[0];
    }

    // ƒê·∫øm xem ID g·ªëc n√†y ƒë√£ c√≥ bao nhi√™u bi·∫øn th·ªÉ r·ªìi
    const variants = this.data.filter(x => x.id.toString().startsWith(baseId + '_V'));
    
    // T√¨m s·ªë l·ªõn nh·∫•t trong c√°c ƒëu√¥i _V...
    let maxV = 0;
    variants.forEach(v => {
        const parts = v.id.toString().split('_V');
        const vNum = parseInt(parts[1]);
        if(!isNaN(vNum) && vNum > maxV) maxV = vNum;
    });

    const nextV = maxV + 1;
    const newVariantId = `${baseId}_V${nextV}`; // VD: K12_..._01_V1

    // Clone d·ªØ li·ªáu
    const clone = JSON.parse(JSON.stringify(q));
    clone.id = newVariantId;
    clone.variant = nextV;
    clone.content = `(Bi·∫øn th·ªÉ c·ªßa ${baseId}) ` + clone.content; // ƒê√°nh d·∫•u ƒë·ªÉ d·ªÖ s·ª≠a

    this.data.push(clone);
    localStorage.setItem('g_rescue_v6', JSON.stringify(this.data));
    this.renderAdmin();
    
    // T·ª± ƒë·ªông m·ªü form s·ª≠a cho c√¢u bi·∫øn th·ªÉ v·ª´a t·∫°o
    setTimeout(() => {
        this.editQ(newVariantId);
        alert(`ƒê√£ t·∫°o bi·∫øn th·ªÉ ${newVariantId}. H√£y s·ª≠a n·ªôi dung!`);
    }, 100);
},
            
            // --- DATA UTILITIES ---
            exportJSON() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `G-RESCUE_Data_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            importJSONFile() {
                const fileInput = document.getElementById('json-input');
                const file = fileInput.files[0];
                if (!file) return alert("Vui l√≤ng ch·ªçn file JSON!");

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) return alert("File kh√¥ng h·ª£p l·ªá (kh√¥ng ph·∫£i danh s√°ch)!");
                        let count = 0;
                        importedData.forEach(q => {
                            const idx = this.data.findIndex(item => item.id == q.id);
                            if (idx !== -1) { this.data[idx] = q; } else { this.data.push(q); }
                            count++;
                        });
                        localStorage.setItem('g_rescue_v6', JSON.stringify(this.data));
                        this.renderAdmin();
                        alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${count} c√¢u h·ªèi!`);
                    } catch (err) { alert("L·ªói ƒë·ªçc file JSON! " + err.message); }
                };
                reader.readAsText(file);
            },
            
            saveToCode() { this.saveFullHTML(); },
            saveFullHTML() {
                let html = document.documentElement.outerHTML;
                const currentDataJSON = JSON.stringify(this.data);
                const currentTreeJSON = JSON.stringify(this.tree);
                const newVersion = Date.now(); 
                const regexData = /const INITIAL_DATA = \[.*?\];/s;
                html = html.replace(regexData, `const INITIAL_DATA = ${currentDataJSON};`);
                const regexTree = /const INITIAL_TREE = \{.*?\};/s;
                html = html.replace(regexTree, `const INITIAL_TREE = ${currentTreeJSON};`);
                const regexVersion = /const DATA_VERSION = \d+;/s;
                html = html.replace(regexVersion, `const DATA_VERSION = ${newVersion};`);
                const blob = new Blob([html], {type: 'text/html'}); 
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); 
                a.download = 'G-RESCUE_Updated.html'; 
                a.click(); 
                alert("ƒê√£ t·∫°o file HTML m·ªõi nh·∫•t. H√£y d√πng file n√†y ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu tr√™n c√°c m√°y kh√°c!");
            },
            clearAllData() { 
                if (confirm("C·∫¢NH B√ÅO: X√ìA TO√ÄN B·ªò c√¢u h·ªèi?")) { 
                    this.data = []; 
                    localStorage.setItem('g_rescue_v6', JSON.stringify(this.data)); 
                    this.renderAdmin(); 
                    alert("ƒê√£ x√≥a d·ªØ li·ªáu tr√™n tr√¨nh duy·ªát. H√£y ·∫•n 'L∆∞u Data' n·∫øu mu·ªën x√≥a c·∫£ trong file."); 
                } 
            },
            
            detectAnswerInText(text) { if (!text) return 'A'; const match = text.match(/(?:ch·ªçn|ƒë√°p √°n|ph∆∞∆°ng √°n|k·∫øt qu·∫£|v·∫≠y)\s*([A-D])/i); return match ? match[1].toUpperCase() : 'A'; },
            extractTFAnswer(text) { let ans = ['0', '0', '0', '0']; const lowerText = text.toLowerCase();
                const compactMatches = [...lowerText.matchAll(/([a-d])\s*[-‚Äì=:]\s*(ƒë√∫ng|sai)/g)];
                if (compactMatches.length > 0) { compactMatches.forEach(m => { const idx = m[1].charCodeAt(0) - 97; if (idx >= 0 && idx < 4) { ans[idx] = (m[2] === 'sai') ? '1' : '0'; } }); } 
                const patterns = [ { key: /√Ω\s*([a-d])\s*(?:l√†)?\s*(?:m·ªánh ƒë·ªÅ)?\s*(ƒë√∫ng|sai)/, idx: -1 }, { key: /m·ªánh ƒë·ªÅ\s*([a-d])\s*(?:l√†)?\s*(ƒë√∫ng|sai)/, idx: -1 }, { key: /([a-d])\)\s*(?:l√†)?\s*(?:m·ªánh ƒë·ªÅ)?\s*(ƒë√∫ng|sai)/, idx: -1 } ];
                patterns.forEach(p => { const matches = [...lowerText.matchAll(new RegExp(p.key, 'g'))]; matches.forEach(m => { let charCode = m[1].charCodeAt(0) - 97; if (charCode >= 0 && charCode < 4) { ans[charCode] = (m[2] === 'sai') ? '1' : '0'; } }); }); return ans.join('|'); },
            extractShortAnswer(text) { if (!text) return ''; const match = text.match(/(?:ƒë√°p √°n|ƒë√°p s·ªë|k·∫øt qu·∫£|gi√° tr·ªã)\s*[:\.]?\s*([-]?\d+([.,]\d+)?)/i); if (match) return match[1]; return ''; },
            async handleWordUpload(event) { const file = event.target.files[0]; if (!file) return; const statusEl = document.getElementById('word-status'); if (statusEl) statusEl.innerText = "ƒêang ƒë·ªçc t·ªáp Word..."; const reader = new FileReader(); reader.onload = async (e) => { const arrayBuffer = e.target.result; try { const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer }); this.parseWordHtml(result.value); } catch (err) { alert("L·ªói khi ƒë·ªçc file Word. H√£y d√πng file .docx chu·∫©n."); if (statusEl) statusEl.innerText = "L·ªói ƒë·ªçc file!"; } }; reader.readAsArrayBuffer(file); },
            parseWordHtml(html) { const statusEl = document.getElementById('word-status'); if (statusEl) statusEl.innerText = "ƒêang b√≥c t√°ch c√¢u h·ªèi..."; const forceType = document.getElementById('word-type').value; const parser = new DOMParser(); const docObj = parser.parseFromString(html, 'text/html'); const paragraphs = docObj.querySelectorAll('p, h1, h2, h3, table'); let drafts = []; let currentQ = null; let currentField = 'content';
                paragraphs.forEach(node => { let text = node.innerText.trim(); let innerHtml = node.innerHTML; const qMatch = text.match(/^(C√¢u|B√†i)\s*(\d+)[:\.]/i); const solMatch = text.match(/^(L·ªùi gi·∫£i|H∆∞·ªõng d·∫´n gi·∫£i|Gi·∫£i chi ti·∫øt|Gi·∫£i|H∆∞·ªõng d·∫´n)[:\.]/i);
                    if (qMatch) { if (currentQ) { if(currentQ.type === 'mcq') currentQ.correct = this.detectAnswerInText(currentQ.explain3); if(currentQ.type === 'short') currentQ.correct = this.extractShortAnswer(currentQ.explain3); if(currentQ.type === 'tf') currentQ.correct = this.extractTFAnswer(currentQ.explain3 + " " + currentQ.content); drafts.push(currentQ); }
                        let initialType = forceType === 'auto' ? 'short' : forceType; currentQ = { content: innerHtml.replace(/^(C√¢u|B√†i)\s*(\d+)[:\.]/i, '').trim(), options: [], correct: '', explain3: '', type: initialType }; currentField = 'content';
                    } else if (solMatch && currentQ) { currentQ.explain3 = innerHtml.replace(/^(L·ªùi gi·∫£i|H∆∞·ªõng d·∫´n gi·∫£i|Gi·∫£i chi ti·∫øt|Gi·∫£i|H∆∞·ªõng d·∫´n)[:\.]/i, '').trim(); currentField = 'explain3';
                    } else if (currentQ) { if (currentField === 'explain3') { currentQ.explain3 += (currentQ.explain3 ? "<br>" : "") + innerHtml; return; }
                        const canBeMCQ = (forceType === 'auto' || forceType === 'mcq'); const canBeTF = (forceType === 'auto' || forceType === 'tf'); const optPattern = /\s*([A-D])[\.\)]\s*/gi; let match; let foundOptions = []; let htmlToProcess = innerHtml;
                        while ((match = optPattern.exec(htmlToProcess)) !== null) { const beforeMatch = htmlToProcess.substring(0, match.index); const dollarCount = (beforeMatch.match(/\$/g) || []).length; if (dollarCount % 2 === 0) { foundOptions.push({ label: match[1].toUpperCase(), index: match.index, fullMatch: match[0] }); } }
                        if (canBeMCQ && foundOptions.length >= 4 && currentQ.type !== 'tf') { currentQ.type = 'mcq'; currentQ.options = ['', '', '', '']; foundOptions.sort((a, b) => a.index - b.index); for (let i = 0; i < foundOptions.length; i++) { const currentOpt = foundOptions[i]; const nextOpt = foundOptions[i+1]; const start = currentOpt.index + currentOpt.fullMatch.length; const end = nextOpt ? nextOpt.index : htmlToProcess.length; const content = htmlToProcess.substring(start, end).trim(); const idx = currentOpt.label.charCodeAt(0) - 65; if (idx >= 0 && idx < 4) { currentQ.options[idx] = content; currentField = 'option' + idx; } }
                        } else if (canBeTF && (text.match(/^[a-d][\)\.]/i) || text.toLowerCase().includes("ƒë√∫ng") || text.toLowerCase().includes("sai"))) { if(currentQ.type !== 'mcq') { currentQ.type = 'tf'; let optContent = text.replace(/^[a-d][\)\.]/i, '').trim(); optContent = optContent.replace(/\((ƒê√∫ng|Sai)\)$/i, '').trim(); currentQ.options.push(optContent); }
                        } else { if (currentField === 'content') { currentQ.content += (currentQ.content ? "<br>" : "") + innerHtml; } else if (currentField.startsWith('option')) { const idx = parseInt(currentField.replace('option', '')); currentQ.options[idx] += (currentQ.options[idx] ? "<br>" : "") + innerHtml; } } } });
                if (currentQ) { if(currentQ.type === 'mcq') currentQ.correct = this.detectAnswerInText(currentQ.explain3); if(currentQ.type === 'short') currentQ.correct = this.extractShortAnswer(currentQ.explain3); if(currentQ.type === 'tf') currentQ.correct = this.extractTFAnswer(currentQ.explain3 + " " + currentQ.content); drafts.push(currentQ); }
                this.wordDrafts = drafts; if (statusEl) statusEl.innerText = `ƒê√£ t√¨m th·∫•y ${drafts.length} c√¢u h·ªèi.`; this.renderWordPreview(); if (drafts.length === 0) { alert("Kh√¥ng t√¨m th·∫•y c·∫•u tr√∫c 'C√¢u 1:', 'A.', 'B.'... Vui l√≤ng ki·ªÉm tra file Word."); } },
            renderWordPreview() { const container = document.getElementById('word-preview'); const btnSave = document.getElementById('btn-save-word'); if (!container) return; container.classList.remove('hidden'); btnSave.classList.remove('hidden'); container.innerHTML = this.wordDrafts.map((q, idx) => `<div class="border p-3 rounded bg-white text-sm word-content"><div class="font-bold mb-1 flex justify-between"><span>C√¢u ${idx + 1}: ${q.type.toUpperCase()}</span><span class="text-blue-600 font-normal ml-2">ƒê√°p √°n: ${q.correct}</span></div><div class="mb-2 p-2 bg-slate-50 border rounded">${q.content}</div>${q.type==='mcq' ? `<div class="grid grid-cols-2 gap-2 mb-2">${q.options.map((opt, i) => `<div class="p-1 border rounded text-xs"><b class="mr-1">${String.fromCharCode(65+i)}.</b> ${opt}</div>`).join('')}</div>` : ''}${q.type==='tf' ? `<div class="mb-2 space-y-1">${q.options.map((opt, i) => `<div class="p-1 border rounded text-xs">- ${opt}</div>`).join('')}</div>` : ''}<div class="text-xs text-slate-500 italic bg-slate-100 p-2 rounded"><b>L·ªùi gi·∫£i:</b> ${q.explain3 || '...'}</div></div>`).join(''); if(window.MathJax) setTimeout(() => MathJax.typesetPromise([container]), 100); },
            // --- 2. S·ª¨A H√ÄM L∆ØU T·ª™ WORD (saveWordDrafts) ---
// --- S·ª¨A H√ÄM L∆ØU T·ª™ WORD (D·ª∞A THEO L·ª∞A CH·ªåN TR√äN GIAO DI·ªÜN) ---
// --- S·ª¨A H√ÄM L∆ØU WORD: T·ª∞ ƒê·ªòNG KH·ªöP ID CHO BI·∫æN TH·ªÇ ---
saveWordDrafts() {
    const g = this.sel.g;
    const c = this.sel.c;
    const l = this.sel.l;
    const lvl = parseInt(document.getElementById('word-lvl').value);
    const variantSelect = document.getElementById('word-var');
    const selectedVariant = variantSelect ? parseInt(variantSelect.value) : 0;

    if (!g || !c || !l) return alert("Ch∆∞a ch·ªçn b√†i h·ªçc (Kh·ªëi/Ch∆∞∆°ng/B√†i)!");

    // L·∫•y Prefix chung (V√≠ d·ª•: K12_C1_B1_MCQ_L1)
    // L∆∞u √Ω: Ta gi·∫£ ƒë·ªãnh 1 file Word th∆∞·ªùng c√πng lo·∫°i c√¢u h·ªèi. 
    // N·∫øu file tr·ªôn nhi·ªÅu lo·∫°i, logic kh·ªõp c·∫∑p n√†y c√≥ th·ªÉ l·ªách n·∫øu th·ª© t·ª± kh√°c nhau.
    const firstType = this.wordDrafts[0]?.type || 'mcq'; 
    const prefix = this.generateBasePrefix(g, c, l, firstType, lvl);

    // [LOGIC M·ªöI] N·∫øu l√† nh·∫≠p bi·∫øn th·ªÉ, ta c·∫ßn l·∫•y danh s√°ch c√°c c√¢u g·ªëc ƒêANG C√ì ƒë·ªÉ kh·ªõp v√†o
    let existingOriginals = [];
    if (selectedVariant > 0) {
        // L·∫•y t·∫•t c·∫£ c√¢u g·ªëc (variant=0) c√≥ c√πng Prefix n√†y, s·∫Øp x·∫øp theo ID tƒÉng d·∫ßn
        existingOriginals = this.data.filter(q => 
            q.id.toString().startsWith(prefix) && 
            q.variant === 0
        ).sort((a, b) => {
            // So s√°nh ph·∫ßn s·ªë cu·ªëi ID: ..._01 vs ..._02
            const numA = parseInt(a.id.split('_').pop());
            const numB = parseInt(b.id.split('_').pop());
            return numA - numB;
        });
    }

    const variantName = selectedVariant === 0 ? "C√¢u G·ªëc" : `Bi·∫øn th·ªÉ ${selectedVariant}`;
    
    if (confirm(`L∆∞u ${this.wordDrafts.length} c√¢u d∆∞·ªõi d·∫°ng: ${variantName.toUpperCase()}?`)) {
        let count = 0;
        
        // D√πng v√≤ng l·∫∑p for c√≥ index ƒë·ªÉ kh·ªõp th·ª© t·ª±
        this.wordDrafts.forEach((d, index) => {
            const currentType = d.type || 'mcq';
            
            // T√°i t·∫°o l·∫°i prefix cho t·ª´ng c√¢u (ƒë·ªÅ ph√≤ng file Word tr·ªôn tr·∫Øc nghi·ªám/t·ª± lu·∫≠n)
            const curPrefix = this.generateBasePrefix(g, c, l, currentType, lvl);
            
            let finalId = "";

            if (selectedVariant === 0) {
                // TR∆Ø·ªúNG H·ª¢P 1: NH·∫¨P C√ÇU G·ªêC -> TƒÉng s·ªë th·ª© t·ª± ti·∫øp theo
                const nextIdx = this.getNextIndex(curPrefix) + 1;
                const indexStr = String(nextIdx).padStart(2, '0');
                finalId = `${curPrefix}_${indexStr}`;
            } else {
                // TR∆Ø·ªúNG H·ª¢P 2: NH·∫¨P BI·∫æN TH·ªÇ -> Kh·ªõp v√†o c√¢u g·ªëc t∆∞∆°ng ·ª©ng
                // C√¢u th·ª© 1 trong file Word s·∫Ω l√† bi·∫øn th·ªÉ c·ªßa C√¢u g·ªëc th·ª© 1 trong DB
                
                if (index < existingOriginals.length) {
                    // N·∫øu t√¨m th·∫•y c√¢u g·ªëc t∆∞∆°ng ·ª©ng theo th·ª© t·ª±
                    const parentId = existingOriginals[index].id;
                    finalId = `${parentId}_V${selectedVariant}`;
                } else {
                    // T√¨nh hu·ªëng: File Word c√≥ 15 c√¢u, nh∆∞ng DB m·ªõi c√≥ 10 c√¢u g·ªëc.
                    // 5 c√¢u th·ª´a ra s·∫Ω ƒë∆∞·ª£c t·∫°o m·ªõi nh∆∞ ID ti·∫øp theo (11, 12...)
                    const nextIdx = this.getNextIndex(curPrefix) + 1;
                    const indexStr = String(nextIdx).padStart(2, '0');
                    finalId = `${curPrefix}_${indexStr}_V${selectedVariant}`;
                }
            }

            // X·ª≠ l√Ω ƒë√°p √°n
            let correctVal = d.correct;
            if (currentType === 'mcq' && typeof d.correct === 'string' && d.correct.length === 1) {
                const charCode = d.correct.toUpperCase().charCodeAt(0);
                if (charCode >= 65 && charCode <= 68) correctVal = charCode - 65;
            }

            this.data.push({
                id: finalId,
                grade: g,
                chapter: c,
                lesson: l,
                level: lvl,
                type: currentType,
                variant: selectedVariant,
                content: d.content,
                options: d.options,
                correct: correctVal,
                theory: "...",
                steps: [],
                solution: d.explain3 || "ƒêang c·∫≠p nh·∫≠t l·ªùi gi·∫£i..."
            });
            count++;
        });

        localStorage.setItem('g_rescue_v6', JSON.stringify(this.data));
        this.wordDrafts = [];
        document.getElementById('word-preview').classList.add('hidden');
        document.getElementById('btn-save-word').classList.add('hidden');
        this.renderAdmin();
        alert(`ƒê√£ l∆∞u ${count} c√¢u. \nV√≠ d·ª• ID c√¢u ƒë·∫ßu ti√™n: ${this.data[this.data.length - count].id}`);
    }
},
            renderStudent() {
                const quotes = [
                    "H·ªçc ƒëi ch·ªù chi! üöÄ",
                    "√Åp l·ª±c t·∫°o kim c∆∞∆°ng, nh∆∞ng ƒë·ª´ng ƒë·ªÉ √°p l·ª±c t·∫°o... 'tr·∫ßm k·∫Ωm' nha! üíé",
                    "Sai th√¨ s·ª≠a, ch·ª≠a th√¨... √† nh·∫ßm, sai th√¨ v√†o Tr·∫°m C·ª©u H·ªô! üõ†Ô∏è",
                    "Top 1 server To√°n h·ªçc b·∫Øt ƒë·∫ßu t·ª´ vi·ªác click b√†i b√™n tr√°i. üëá",
                    "Kh√¥ng l√†m m√† ƒë√≤i c√≥ ƒÉn th√¨ ch·ªâ c√≥... l√†m b√†i t·∫≠p G-Rescue th√¥i! üçö"
                ];
                const quote = quotes[Math.floor(Math.random() * quotes.length)];

                document.getElementById('app-container').innerHTML = `
                    <div class="grid grid-cols-12 gap-6 w-full max-w-7xl mx-auto fade-in">
                        <div class="col-span-3 bg-white p-4 rounded-xl shadow h-fit border border-slate-100">
                            <h3 class="font-bold text-slate-500 mb-4 border-b pb-2">CH∆Ø∆†NG TR√åNH H·ªåC</h3>
                            ${this.renderStudentTree()}
                        </div>
                        <div id="student-main" class="col-span-9 bg-white p-8 rounded-xl shadow border border-slate-100 min-h-[500px] flex items-center justify-center text-center">
                            <div class="text-center max-w-lg mx-auto">
                                <img src="https://cdn-icons-png.flaticon.com/512/3750/3750019.png" class="w-32 mx-auto mb-6 opacity-90 hover:scale-110 transition duration-500">
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">S·∫µn s√†ng 'Out Tr√¨nh' ch∆∞a? üòé</h2>
                                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6 text-sm text-indigo-800">
                                    <i class="fa-solid fa-quote-left opacity-50 mr-2"></i> ${quote}
                                </div>
                                <div class="text-left bg-white p-6 rounded-xl border border-slate-100 shadow-sm space-y-4">
                                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-2">üéÆ H∆∞·ªõng d·∫´n ph√° ƒë·∫£o:</h4>
                                    <div class="flex items-start gap-3">
                                        <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">1</span>
                                        <p class="text-slate-600 text-sm">Ch·ªçn b√†i h·ªçc ·ªü menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="bg-red-100 text-red-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">2</span>
                                        <p class="text-slate-600 text-sm">L√†m b√†i test <b>Giai ƒëo·∫°n 1</b>. ƒê·ª´ng lo n·∫øu sai!</p>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="bg-amber-100 text-amber-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">3</span>
                                        <p class="text-slate-600 text-sm">V√†o <b>Tr·∫°m C·ª©u H·ªô</b> ƒë·ªÉ ƒë∆∞·ª£c Mentor AI "ch·ªØa l√†nh" ki·∫øn th·ª©c.</p>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <span class="bg-green-100 text-green-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0">4</span>
                                        <p class="text-slate-600 text-sm">L√†m b√†i <b>Ch·ªët H·∫°</b> ƒë·ªÉ kh·∫≥ng ƒë·ªãnh ƒë·∫≥ng c·∫•p.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            },
            renderStudentTree() {
                let html = '';
                for(const g in this.tree) {
                    html += `<details open class="group mb-2"><summary class="font-bold text-slate-700 p-2 hover:bg-slate-50 rounded cursor-pointer">${g}</summary><div class="pl-4 border-l ml-2">`;
                    for(const c in this.tree[g]) {
                        html += `<details open class="mt-1"><summary class="text-sm font-semibold text-slate-600 p-1 hover:text-blue-600 cursor-pointer">${c}</summary><div class="pl-3 mt-1 space-y-1">`;
                        this.tree[g][c].forEach(l => {
                            html += `<div onclick="app.startFlow('${g}','${c}','${l}')" class="text-xs text-slate-500 p-2 rounded hover:bg-blue-50 hover:text-blue-700 cursor-pointer flex items-center"><i class="fa-solid fa-circle-play mr-2 text-[8px]"></i> ${l}</div>`;
                        });
                        html += `</div></details>`;
                    }
                    html += `</div></details>`;
                }
                return html;
            },

            async renderContent(content) {
                const container = document.createElement('div');
                container.innerHTML = content;
                if (content.includes("tikzpicture") || content.includes("tabular")) {
                    const imgUrl = await window.renderLatexTableToImage(content);
                    if (imgUrl) {
                        return content.replace(/\\begin\{center\}.*?\\end\{center\}/s, `<img src="${imgUrl}" class="mx-auto my-2 border rounded"/>`)
                                    .replace(/\\begin\{tikzpicture\}.*?\\end\{tikzpicture\}/s, `<img src="${imgUrl}" class="mx-auto my-2 border rounded"/>`);
                    }
                }
                return content;
            },

            startFlow(g,c,l) {
                this.answers = {};
                this.reviewQueue = [];
                this.reviewIndex = 0;
                this.phase = 1;
                this.doneVariants = [];

                const main = document.getElementById('student-main');
                main.className = "col-span-9 bg-white p-8 rounded-xl shadow border border-slate-100";
                main.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full min-h-[400px] fade-in">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p class="text-slate-600 font-medium">ƒêang t·∫£i b·ªô ƒë·ªÅ...</p>
                        <p class="text-sm text-slate-400 mt-1">${l}</p>
                    </div>
                `;

                setTimeout(() => {
                    let pool = this.data.filter(q => q.grade===g && q.chapter===c && q.lesson===l && q.variant === 0);
                    if(pool.length === 0) {
                        pool = this.data.filter(q => q.grade===g && q.chapter===c && q.lesson===l);
                    }
                    if(pool.length === 0) {
                        main.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full min-h-[400px] text-center fade-in">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fa-solid fa-clipboard-question text-3xl text-slate-400"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-700">Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                                <p class="text-slate-500 mt-2 max-w-md">B√†i h·ªçc "<b>${l}</b>" hi·ªán ch∆∞a c√≥ c√¢u h·ªèi n√†o trong ng√¢n h√†ng.</p>
                                <p class="text-xs text-slate-400 mt-4">Vui l√≤ng li√™n h·ªá Gi√°o vi√™n/Admin ƒë·ªÉ b·ªï sung c√¢u h·ªèi.</p>
                            </div>
                        `;
                        return;
                    }
                    this.quiz = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
                    this.renderPhase1();
                }, 300); 
            },

            async renderPhase1() {
                const main = document.getElementById('student-main');
                main.className = "col-span-9 bg-white p-8 rounded-xl shadow border-t-4 border-red-500";
                let html = `<div class="w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-red-600">üî¥ C√îNG ƒêO·∫†N 1: TI·∫æP NH·∫¨N & ƒê√ÅNH GI√Å</h2>
                        <div class="flex gap-2">
                            <span class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold flex items-center">${this.quiz.length} C√¢u</span>
                            <button onclick="app.renderStudent()" class="text-slate-400 hover:text-red-500 text-sm px-2"><i class="fa-solid fa-right-from-bracket"></i> Tho√°t</button>
                        </div>
                    </div>`;
                
                for (let i=0; i<this.quiz.length; i++) {
                    const q = this.quiz[i];
                    const contentHtml = await this.renderContent(q.content);
                    html += `<div class="mb-6 p-4 border border-slate-100 rounded-lg"><div class="font-bold text-slate-700 mb-2">C√¢u ${i+1} <span class="text-xs font-normal text-slate-400">(${q.type.toUpperCase()})</span>:</div><div class="mb-3 text-slate-800" id="q-content-${i}">${contentHtml}</div>`;
                    if (q.type === 'mcq') {
                        html += `<div class="grid grid-cols-2 gap-3">` + q.options.map((o, idx) => 
                            `<label class="flex items-center p-3 border rounded cursor-pointer hover:bg-slate-50"><input type="radio" name="q${q.id}" value="${idx}" class="mr-3" onchange="app.answers[${q.id}]='${idx}'"> ${o}</label>`
                        ).join('') + `</div>`;
                    } else if (q.type === 'tf') {
                         html += `<div class="grid grid-cols-1 gap-2">` + q.options.map((o, idx) => `
                            <div class="flex items-center justify-between p-2 border rounded bg-slate-50">
                                <span class="text-sm flex-1 mr-4">${o}</span>
                                <div class="flex gap-2">
                                    <label class="flex items-center text-xs"><input type="radio" name="q${q.id}_${idx}" value="0" onchange="app.setTFAnswer('${q.id}', ${idx}, '0')"> ƒê</label>
                                    <label class="flex items-center text-xs"><input type="radio" name="q${q.id}_${idx}" value="1" onchange="app.setTFAnswer('${q.id}', ${idx}, '1')"> S</label>
                                </div>
                            </div>
                        `).join('') + `</div>`;
                    } else {
                        html += `<div class="flex gap-2 justify-start">
                            <input type="text" maxlength="1" class="w-10 h-10 border-2 border-slate-300 rounded text-center text-lg font-bold focus:border-blue-500 focus:outline-none uppercase" onkeyup="app.setShortAnswer('${q.id}', 0, this)">
                            <input type="text" maxlength="1" class="w-10 h-10 border-2 border-slate-300 rounded text-center text-lg font-bold focus:border-blue-500 focus:outline-none uppercase" onkeyup="app.setShortAnswer('${q.id}', 1, this)">
                            <input type="text" maxlength="1" class="w-10 h-10 border-2 border-slate-300 rounded text-center text-lg font-bold focus:border-blue-500 focus:outline-none uppercase" onkeyup="app.setShortAnswer('${q.id}', 2, this)">
                            <input type="text" maxlength="1" class="w-10 h-10 border-2 border-slate-300 rounded text-center text-lg font-bold focus:border-blue-500 focus:outline-none uppercase" onkeyup="app.setShortAnswer('${q.id}', 3, this)">
                        </div>`;
                    }
                    html += `</div>`;
                }
                html += `<button onclick="app.submitPhase1()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-lg mt-4">N·ªòP B√ÄI</button></div>`;
                main.innerHTML = html;
                MathJax.typeset();
            },

            setTFAnswer(qId, optIdx, val) {
                if(!this.answers[qId]) this.answers[qId] = {};
                this.answers[qId][optIdx] = val;
            },

            setShortAnswer(qId, idx, input) {
                if(!this.answers[qId]) this.answers[qId] = ['', '', '', ''];
                this.answers[qId][idx] = input.value.toUpperCase();
                if(input.value && idx < 3) {
                    input.nextElementSibling.focus();
                }
            },

            submitPhase1() {
                let score = 0; 
                this.reviewQueue = [];
                let detailHtml = '';

                this.quiz.forEach((q, idx) => {
                    let isCorrect = false;
                    
                    if(q.type==='mcq') { 
                        if(this.answers[q.id] == q.correct) isCorrect = true; 
                    }
                    else if(q.type==='tf') {
                        const correctArr = q.correct.split('|');
                        const userArr = this.answers[q.id] || {};
                        let allMatch = true;
                        for(let k=0; k<correctArr.length; k++) { if(userArr[k] !== correctArr[k]) allMatch = false; }
                        if(allMatch) isCorrect = true;
                    }
                    else if(q.type==='short') { 
                        const userAns = (this.answers[q.id] || []).join('').trim();
                        let correctAns = q.correct.toString().trim().toUpperCase();
                        if(userAns === correctAns) isCorrect = true;
                        else if (!isNaN(parseFloat(userAns.replace(',','.'))) && !isNaN(parseFloat(correctAns.replace(',','.'))) && parseFloat(userAns.replace(',','.')) === parseFloat(correctAns.replace(',','.'))) isCorrect = true;
                    }
                    
                    if(isCorrect) score++; else this.reviewQueue.push(q);

                    detailHtml += `
                        <div class="flex justify-between items-center p-2 border-b text-sm">
                            <span>C√¢u ${idx+1}</span>
                            <span class="${isCorrect ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}">${isCorrect ? 'ƒê√öNG' : 'SAI'}</span>
                        </div>
                    `;
                });

                const cmt = score === this.quiz.length ? "Tuy·ªát v·ªùi! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c." : "ƒê·ª´ng lo, v√†o Tr·∫°m c·ª©u h·ªô ƒë·ªÉ √¥n t·∫≠p l·∫°i nh√©!";

                document.getElementById('student-main').innerHTML = `
                    <div class="text-center py-10 w-full fade-in">
                        <div class="text-6xl mb-4">üìä</div>
                        <h2 class="text-3xl font-bold text-slate-800">ƒêi·ªÉm s·ªë: <span class="text-red-600">${score}/${this.quiz.length}</span></h2>
                        <div class="max-w-md mx-auto mt-6 bg-white border rounded-lg shadow-sm text-left">
                            <div class="bg-slate-100 p-2 font-bold text-slate-700">Chi ti·∫øt k·∫øt qu·∫£</div>
                            ${detailHtml}
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl mt-6 border border-blue-100 inline-block max-w-lg">
                            <div class="text-xs font-bold text-blue-50 uppercase mb-1">Mentor G nh·∫≠n x√©t:</div>
                            <p class="text-lg italic text-slate-700">"${cmt}"</p>
                        </div>
                        <div class="mt-8">
                            <button onclick="app.startPhase2()" class="bg-amber-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-amber-600 transition animate-bounce">
                                üöÄ V√†o Tr·∫°m C·ª©u H·ªô (${this.reviewQueue.length} c√¢u sai)
                            </button>
                        </div>
                    </div>`;
            },

            startPhase2() {
                if(this.reviewQueue.length === 0) return this.finishSession(true);
                this.reviewIndex = 0;
                this.phase = 2;
                this.renderRescueItem();
            },

            async renderRescueItem() {
                const q = this.reviewQueue[this.reviewIndex];
                const main = document.getElementById('student-main');
                main.className = "col-span-9 bg-white p-0 rounded-xl shadow border-t-4 border-amber-500 overflow-hidden";
                const contentHtml = await this.renderContent(q.content);

                main.innerHTML = `
                    <div class="flex flex-col h-[600px]">
                        <div class="bg-amber-50 p-4 border-b border-amber-100 flex justify-between items-center">
                            <h2 class="font-bold text-amber-700">üü° C·ª®U H·ªò: C√ÇU ${this.reviewIndex + 1}/${this.reviewQueue.length}</h2>
                            <div class="flex space-x-2 text-sm">
                                <button onclick="app.setTab(1)" id="tab1" class="px-3 py-1 bg-white border rounded shadow-sm text-amber-600 font-bold">1. G·ª£i m·ªü</button>
                                <button onclick="app.setTab(2)" id="tab2" class="px-3 py-1 bg-slate-100 border rounded text-slate-500">2. L·ªùi gi·∫£i</button>
                                <button onclick="app.setTab(3)" id="tab3" class="px-3 py-1 bg-slate-100 border rounded text-slate-500">3. Luy·ªán bi·∫øn th·ªÉ</button>
                            </div>
                        </div>
                        <div class="flex-grow p-6 overflow-y-auto" id="tab-content"></div>
                        <div class="p-4 border-t bg-slate-50 flex justify-between">
                            <button onclick="app.goLanding()" class="text-slate-400 text-sm">Tho√°t</button>
                            <button onclick="app.nextRescue()" class="bg-slate-800 text-white px-6 py-2 rounded hover:bg-black">Ti·∫øp theo <i class="fa-solid fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>`;
                this.currentQHtml = contentHtml;
                this.setTab(1);
            },

            setTab(t) {
                [1,2,3].forEach(i => {
                    const btn = document.getElementById(`tab${i}`);
                    if(i===t) btn.className = "px-3 py-1 bg-white border rounded shadow-sm text-amber-600 font-bold border-amber-200";
                    else btn.className = "px-3 py-1 bg-slate-100 border rounded text-slate-500 hover:bg-slate-200";
                });

                const container = document.getElementById('tab-content');
                const q = this.reviewQueue[this.reviewIndex];
                
                const aiTheory = this.getAIAnalysis(q);
                const aiSteps = this.generateAISolutionSteps(q.content);

                if (t === 1) {
                    container.innerHTML = `
                        <div class="text-lg font-medium text-slate-800 mb-6">${this.currentQHtml}</div>
                        <div class="mt-6 space-y-4 fade-in">
                            ${aiTheory}
                        </div>`;
                } else if (t === 2) {
                    container.innerHTML = `
                        <div class="h-full overflow-y-auto pr-2 custom-scrollbar">
                            <div class="text-sm font-medium text-slate-500 mb-2 uppercase tracking-wide">ƒê·ªÅ b√†i</div>
                            <div class="text-base text-slate-800 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200 shadow-sm">${this.currentQHtml}</div>
                            <div class="space-y-6 fade-in">
                                ${aiSteps}
                                <div class="bg-white rounded-xl border-l-4 border-green-500 shadow-sm p-5 ring-1 ring-slate-100">
                                    <h3 class="font-bold text-green-700 text-lg mb-4 flex items-center gap-2">
                                        <i class="fa-solid fa-check-circle"></i> L·ªùi gi·∫£i chi ti·∫øt
                                    </h3>
                                    <div class="prose prose-slate max-w-none text-slate-800 leading-relaxed text-sm md:text-base">
                                        ${q.solution ? q.solution.split('\n').map(p => `<p class="mb-2">${p}</p>`).join('') : 'ƒêang c·∫≠p nh·∫≠t l·ªùi gi·∫£i...'}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    this.renderVariantTab();
                }
                MathJax.typeset();
            },
            
// --- 4. S·ª¨A H√ÄM HI·ªÇN TH·ªä LUY·ªÜN T·∫¨P BI·∫æN TH·ªÇ (renderVariantTab) ---
renderVariantTab() {
    const q = this.reviewQueue[this.reviewIndex];
    
    // 1. L·∫•y ID g·ªëc. N·∫øu q l√† bi·∫øn th·ªÉ (..._V1) th√¨ c·∫Øt ƒëu√¥i, n·∫øu l√† g·ªëc th√¨ gi·ªØ nguy√™n
    const baseId = q.id.toString().split('_V')[0]; 

    // 2. L·ªçc c√°c bi·∫øn th·ªÉ trong Database
    let variants = this.data.filter(v => 
        v.id.toString().startsWith(baseId + '_V') && // B·∫Øt ƒë·∫ßu b·∫±ng ID g·ªëc + _V
        !this.doneVariants.includes(v.id)            // Ch∆∞a l√†m
    );

    // S·∫Øp x·∫øp theo th·ª© t·ª± V1, V2, V3...
    variants.sort((a, b) => {
        const vA = parseInt(a.id.split('_V')[1] || 0);
        const vB = parseInt(b.id.split('_V')[1] || 0);
        return vA - vB;
    });

    const container = document.getElementById('tab-content');

    if (variants.length === 0) { 
        container.innerHTML = `
            <div class="text-center pt-10 fade-in">
                <div class="text-6xl mb-4">üéâ</div>
                <h3 class="text-xl font-bold text-slate-700 mb-2">ƒê√£ h·∫øt bi·∫øn th·ªÉ!</h3>
                <p class="text-slate-500 mb-6">Em ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c b√†i t·∫≠p t∆∞∆°ng t·ª± c·ªßa ID: <b>${baseId}</b>.</p>
                <button onclick="app.setTab(1)" class="text-blue-600 hover:underline">Quay l·∫°i xem l√Ω thuy·∫øt</button>
            </div>`; 
        return; 
    }

    container.innerHTML = `
        <div class="text-center pt-6 fade-in">
            <h3 class="text-xl font-bold text-slate-700 mb-2">Luy·ªán t·∫≠p bi·∫øn th·ªÉ</h3>
            <p class="text-slate-500 mb-6 text-sm">G·ªëc: <span class="font-mono bg-slate-100 px-2 rounded">${baseId}</span> - T√¨m th·∫•y ${variants.length} b√†i t∆∞∆°ng t·ª±.</p>
            
            <div class="flex flex-wrap justify-center gap-3 mb-8">
                ${variants.map((v, i) => `
                    <button onclick="app.selectVariant('${v.id}')" class="px-4 py-2 bg-white border-2 border-purple-100 text-purple-600 rounded-xl hover:bg-purple-50 hover:border-purple-300 font-bold shadow-sm transition flex flex-col items-center min-w-[100px]">
                        <span class="text-xs uppercase text-purple-400">Bi·∫øn th·ªÉ</span>
                        <span class="text-lg">#${v.id.split('_V')[1]}</span>
                    </button>
                `).join('')}
            </div>
            
            <div id="variant-display-area" class="text-left hidden fade-in border p-6 rounded-2xl bg-white shadow-xl border-slate-100 max-w-4xl mx-auto ring-4 ring-slate-50 relative">
                <button onclick="document.getElementById('variant-display-area').classList.add('hidden')" class="absolute top-2 right-2 w-8 h-8 bg-slate-100 rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                <div id="variant-content-placeholder"></div>
            </div>
        </div>`;
},

// H√†m h·ªó tr·ª£ ƒë·ªÉ hi·ªÉn th·ªã n·ªôi dung bi·∫øn th·ªÉ khi click n√∫t
async selectVariant(vId) {
    const variant = this.data.find(v => v.id == vId);
    if(!variant) return;
    
    const displayArea = document.getElementById('variant-display-area');
    const placeholder = document.getElementById('variant-content-placeholder');
    
    displayArea.classList.remove('hidden');
    
    // Render n·ªôi dung (x·ª≠ l√Ω LaTeX/·∫¢nh)
    const contentHtml = await this.renderContent(variant.content);
    
    let html = `
        <div class="flex items-center gap-2 mb-4 border-b pb-2">
            <span class="bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded">Bi·∫øn th·ªÉ #${variant.id.split('_V')[1]}</span>
            <span class="text-xs text-slate-400 font-mono">${variant.id}</span>
        </div>
        <div class="text-slate-800 text-base mb-4 font-medium">${contentHtml}</div>
    `;

    // Render Options d·ª±a tr√™n lo·∫°i c√¢u h·ªèi
    if (variant.type === 'mcq') {
        html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">` + 
            variant.options.map((o, i) => `
                <button id="v-opt-${i}" onclick="app.checkVariantResult('${vId}', ${i})" class="text-left p-3 border rounded-lg hover:bg-slate-50 transition relative group">
                    <span class="font-bold text-slate-400 mr-2 group-hover:text-blue-600">${String.fromCharCode(65+i)}.</span> ${o}
                </button>
            `).join('') + 
        `</div>`;
    } else if (variant.type === 'short') {
        html += `
            <div class="flex gap-2 items-center">
                <span class="text-sm font-bold text-slate-600">Tr·∫£ l·ªùi:</span>
                <input type="text" class="v-short-${vId} border-2 border-slate-300 rounded p-2 w-full max-w-xs focus:border-purple-500 outline-none font-bold uppercase" placeholder="Nh·∫≠p ƒë√°p √°n...">
                <button onclick="app.checkVariantResult('${vId}', null)" class="bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700">Ki·ªÉm tra</button>
            </div>
        `;
    } else if (variant.type === 'tf') {
        // X·ª≠ l√Ω ƒë√∫ng sai cho bi·∫øn th·ªÉ (n·∫øu c·∫ßn)
        html += `<div class="italic text-slate-500">D·∫°ng ƒë√∫ng/sai ch∆∞a h·ªó tr·ª£ l√†m nhanh ·ªü ch·∫ø ƒë·ªô bi·∫øn th·ªÉ. <button onclick="app.checkVariantResult('${vId}', null)" class="text-blue-600 underline">Xem ƒë√°p √°n ngay</button></div>`;
    }

    html += `<div id="variant-feedback-${vId}" class="hidden mt-4"></div>`;
    
    placeholder.innerHTML = html;
    MathJax.typeset();
    
    // Cu·ªôn xu·ªëng v√πng hi·ªÉn th·ªã
    displayArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
},

            checkVariantResult(vId, userChoice) {
                 const variant = this.data.find(v => v.id == vId);
                 const feedbackEl = document.getElementById(`variant-feedback-${vId}`);
                 const correctIdx = variant.correct;
                 let isCorrect = false;

                 if (variant.type === 'mcq') {
                     variant.options.forEach((_, i) => {
                         const btn = document.getElementById(`v-opt-${i}`); if(btn) btn.disabled = true;
                         if (i == correctIdx) btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                         else if (i == userChoice) btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                     });
                     isCorrect = (userChoice === correctIdx);
                 } else if (variant.type === 'short') {
                     const inputs = document.querySelectorAll(`.v-short-${vId}`);
                     let userVal = "";
                     inputs.forEach(i => userVal += i.value.toUpperCase());
                     let correctVal = variant.correct.toString().toUpperCase().trim();
                     inputs.forEach(i => i.disabled = true);
                     if(userVal === correctVal || (parseFloat(userVal.replace(',','.')) === parseFloat(correctVal.replace(',','.')))) {
                         isCorrect = true;
                         inputs.forEach(i => i.classList.add('border-green-500', 'bg-green-50'));
                     } else {
                         inputs.forEach(i => i.classList.add('border-red-500', 'bg-red-50'));
                     }
                 } else {
                     isCorrect = true; 
                 }
                 
                 if (isCorrect) {
                     feedbackEl.className = "mt-4 p-4 rounded-xl text-sm border bg-green-50 border-green-200 text-green-800 fade-in";
                     feedbackEl.innerHTML = `<div class="flex items-center gap-2 font-bold text-lg mb-2"><i class="fa-solid fa-check-circle"></i> Ch√≠nh x√°c! Out tr√¨nh lu√¥n!</div><div class="mt-2 text-slate-700"><b>L·ªùi gi·∫£i chi ti·∫øt:</b><br>${variant.solution}</div>`;
                     if(!this.doneVariants.includes(vId)) this.doneVariants.push(vId);
                 } else {
                     feedbackEl.className = "mt-4 p-4 rounded-xl text-sm border bg-red-50 border-red-200 text-red-800 fade-in";
                     feedbackEl.innerHTML = `<div class="flex items-center gap-2 font-bold text-lg mb-2"><i class="fa-solid fa-circle-xmark"></i> Sai r·ªìi, xu c√† na qu√°!</div><div class="mt-2 text-slate-700"><b>Xem l·ªùi gi·∫£i ƒë·ªÉ "ch·ªØa l√†nh" ki·∫øn th·ª©c nh√©:</b><br>${variant.solution}</div>`;
                 }
                 feedbackEl.classList.remove('hidden');
                 MathJax.typeset();
            },

            nextRescue() { this.reviewIndex++; if(this.reviewIndex < this.reviewQueue.length) this.renderRescueItem(); else this.startPhase3(); },
            
            async startPhase3() {
                if (this.reviewQueue.length === 0) return this.finishSession(true); 

                const pool = this.reviewQueue; 
                const main = document.getElementById('student-main');
                main.className = "col-span-9 bg-white p-8 rounded-xl shadow border-t-4 border-green-500";
                
                let html = `<div class="w-full"><h2 class="text-xl font-bold text-green-700 mb-6">üü¢ C√îNG ƒêO·∫†N 3: TEST CH·ªêT H·∫† (L√†m l·∫°i c√¢u sai)</h2><div class="space-y-8">`;
                
                for(let i=0; i<pool.length; i++) {
                    const q = pool[i];
                    const contentHtml = await this.renderContent(q.content);
                    html += `<div class="bg-slate-50 p-5 rounded-xl border border-slate-100"><div class="font-bold text-slate-700 mb-2">C√¢u ${i+1}:</div><div class="mb-4">${contentHtml}</div><div class="grid grid-cols-2 gap-3" id="p3-q${i}">${q.options && q.type==='mcq' ? q.options.map((o, idx) => `<button onclick="app.checkInstant(${i}, ${idx}, ${q.correct}, '${q.solution.replace(/"/g, '&quot;').replace(/'/g, "\\'")}')" class="p-3 border rounded bg-white hover:bg-slate-100 text-left transition relative">${o}</button>`).join('') : `<div class="col-span-2 text-center text-sm"><button onclick="document.getElementById('feed-${i}').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded">Xem ƒë√°p √°n & L·ªùi gi·∫£i</button></div>`}</div><div id="feed-${i}" class="hidden mt-3 p-3 rounded text-sm bg-green-50 text-green-800 border border-green-200"><b>L·ªùi gi·∫£i chi ti·∫øt:</b><br>${q.solution}</div></div>`;
                }
                
                html += `</div><div class="text-center mt-8"><button onclick="app.finishSession()" class="bg-slate-800 text-white px-8 py-3 rounded-full hover:bg-black font-bold shadow-lg animate-bounce">Ho√†n th√†nh bu·ªïi h·ªçc üéâ</button></div></div>`;
                main.innerHTML = html;
                MathJax.typeset();
            },

            checkInstant(qIdx, ansIdx, correctIdx, sol) { 
                const container = document.getElementById(`p3-q${qIdx}`); 
                const btns = container.getElementsByTagName('button'); 
                const feed = document.getElementById(`feed-${qIdx}`); 
                for(let b of btns) b.disabled = true; 
                
                if(ansIdx === correctIdx) { 
                    btns[ansIdx].classList.add('bg-green-100', 'border-green-500', 'text-green-700'); 
                    feed.innerHTML = `<strong>Ch√≠nh x√°c!</strong> ${sol}`; 
                } else { 
                    btns[ansIdx].classList.add('bg-red-100', 'border-red-500', 'text-red-700'); 
                    btns[correctIdx].classList.add('bg-green-100', 'border-green-500', 'text-green-700'); 
                    feed.innerHTML = `<strong>Sai r·ªìi!</strong> ${sol}`; 
                } 
                feed.classList.remove('hidden'); 
                MathJax.typeset(); 
            },
            
            finishSession(isPerfect = false) {
                const quotes = isPerfect 
                    ? ["Hack game √†? üò±", "Out tr√¨nh server!", "ƒê·ªânh n√≥c k·ªãch tr·∫ßn!", "10 ƒëi·ªÉm v·ªÅ ch·ªó!"] 
                    : ["Sai th√¨ s·ª≠a, ch·ª≠a... √† nh·∫ßm, sai th√¨ l√†m l·∫°i!", "H·∫øt n∆∞·ªõc ch·∫•m!", "V·ªÅ ƒë√≠ch an to√†n!", "Non nh∆∞ng c√≥ c·ªë g·∫Øng!"];
                const quote = quotes[Math.floor(Math.random() * quotes.length)];
                
                const confettiContainer = document.createElement('div');
                for(let i=0; i<50; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    c.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confettiContainer.appendChild(c);
                }
                document.body.appendChild(confettiContainer);
                setTimeout(() => confettiContainer.remove(), 5000);

                const main = document.getElementById('student-main');
                main.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full min-h-[500px] text-center fade-in relative z-10">
                        <div class="mb-6 text-6xl animate-bounce">üèÜ</div>
                        <h2 class="text-4xl font-bold text-slate-800 mb-4">CH√öC M·ª™NG!</h2>
                        <p class="text-xl text-slate-600 mb-8 max-w-md mx-auto">"${quote}"</p>
                        <div class="bg-yellow-100 border border-yellow-200 p-4 rounded-xl mb-8">
                            <p class="text-yellow-800 font-bold"><i class="fa-solid fa-star text-yellow-500"></i> B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc bu·ªïi h·ªçc!</p>
                        </div>
                        <button onclick="app.goLanding()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition">Quay v·ªÅ s·∫£nh ch√≠nh</button>
                    </div>
                `;
            },
            
            getAIAnalysis(q) {
                const sol = q.solution.toLowerCase();
                const content = q.content.toLowerCase();
                let advice = "";
                const intros = [ "Alo alo! üì£ B√¨nh tƒ©nh n√†o, **c√≤n th·ªü l√† c√≤n g·ª°**.", "√ât √¥ √©t üÜò! Ca n√†y nh√¨n h∆°i **xu c√† na** nh∆∞ng ƒë·ªÉ th·∫ßy **g√°nh team** cho.", "Nghe th·∫ßy **flex** nh·∫π skill n√†y l√† **healing** g·ªëc To√°n ngay v√† lu√¥n.", "ƒê·ª´ng ƒë·ªÉ b√†i to√°n **thao t√∫ng t√¢m l√Ω** üòµ‚Äçüí´. T·ª± tin l√™n, **g√©t g√¥**!", "T√≠n hi·ªáu v≈© tr·ª• üåå m√°ch b·∫£o: Em s·∫Øp **out tr√¨nh** b√†i n√†y r·ªìi!" ];
                const selectedIntro = intros[Math.floor(Math.random() * intros.length)];
                if (sol.includes("ƒë·∫°o h√†m") || sol.includes("y'")) advice += " ƒê·∫ßu ti√™n, ph·∫£i 'check map' b·∫±ng c√°i ƒë·∫°o h√†m $y'$. ƒê√¢y l√† ch√¨a kh√≥a ƒë·ªÉ **m·ªü b√°t** b√†i n√†y.";
                if (sol.includes("x√©t d·∫•u") || sol.includes("b·∫£ng bi·∫øn thi√™n")) advice += " Ti·∫øp theo, v·∫Ω c√°i b·∫£ng bi·∫øn thi√™n 's∆∞∆°ng s∆∞∆°ng'. Nh·ªõ soi d·∫•u cho k·ªπ, sai m·ªôt ly l√† ƒëi m·ªôt s·∫£i ra ƒë·∫£o ch∆°i v·ªõi kh·ªâ ƒë·∫•y üèùÔ∏è.";
                if (sol.includes("ph∆∞∆°ng tr√¨nh") && sol.includes("nghi·ªám")) advice += " Gi·∫£i ph∆∞∆°ng tr√¨nh t√¨m nghi·ªám ƒëi n√†o. Coi ch·ª´ng b·ªã **l√πa g√†** b·ªüi m·∫•y c√°i nghi·ªám k√©p nha.";
                if (sol.includes("th·ªÉ t√≠ch") && (sol.includes("ƒë√°y") || sol.includes("cao"))) advice += " Nh·ªõ c√¥ng th·ª©c th·ªÉ t√≠ch ch∆∞a? Quan tr·ªçng l√† c√°i chi·ªÅu cao v·ªõi di·ªán t√≠ch ƒë√°y, ƒë·ª´ng ƒë·ªÉ b·ªã 'lag' ch·ªó n√†y.";
                if (sol.includes("ƒëi·ªÅu ki·ªán") || sol.includes("t·∫≠p x√°c ƒë·ªãnh")) advice += " ƒê·ª´ng qu√™n t√¨m ƒêKXƒê. Qu√™n c√°i n√†y l√† **bay m√†u** ƒëi·ªÉm s·ªë ƒë√≥.";
                if (sol.includes("ti·ªám c·∫≠n")) advice += " Nh·ªõ k·ªπ: V√¥ c·ª±c l√† Ngang, Kh√¥ng x√°c ƒë·ªãnh l√† ƒê·ª©ng. ƒê·ª´ng ƒë·ªÉ b·ªã **thao t√∫ng**!";
                if (advice === "") advice = "ƒê·ªçc k·ªπ ƒë·ªÅ b√†i, ƒë·ª´ng 'tay nhanh h∆°n n√£o'. Th∆∞·ªùng th√¨ g·ª£i √Ω n√≥ n·∫±m l√π l√π trong ƒë√≥ √°.";
                return `<div class="bg-genz p-1 rounded-xl shadow-md transform transition hover:scale-[1.01] duration-300"><div class="bg-white p-5 rounded-lg h-full relative overflow-hidden"><div class="absolute top-0 right-0 p-3 opacity-10"><i class="fa-solid fa-face-grin-squint-tears text-6xl text-purple-600"></i></div><h3 class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600 text-lg mb-3 flex items-center gap-2">üòé Th·∫ßy Gi√°o Gen Z (H·ªá T√≥p T√≥p)</h3><div class="text-slate-700 text-sm leading-relaxed text-justify font-medium"><p class="mb-3 italic text-purple-600 font-semibold text-base">"${selectedIntro}"</p><div class="bg-blue-50 p-3 rounded-lg border border-blue-100"><p class="flex gap-2"><span class="text-xl">üí°</span> <span>${advice}</span></p></div><p class="mt-3 text-xs text-slate-400 text-right italic border-t pt-2">* G·ª£i √Ω n√†y ƒë∆∞·ª£c t√†i tr·ª£ b·ªüi nh√¢n ph·∫©m c·ªßa ng∆∞·ªùi l√†m b√†i ‚ú®</p></div></div></div>`;
            },
            
            generateAISolutionSteps(content) {
                const c = content.toLowerCase();
                let steps = [];
                let title = "Quy tr√¨nh x·ª≠ l√Ω";
                if (c.includes("b·∫£ng bi·∫øn thi√™n") && (c.includes("ƒë·ªìng bi·∫øn") || c.includes("ngh·ªãch bi·∫øn"))) { title = "Ph∆∞∆°ng ph√°p: Soi B·∫£ng Bi·∫øn Thi√™n"; steps = ["Nh√¨n v√†o d√≤ng $y'$.", "T√¨m kho·∫£ng c√≥ d·∫•u (+) l√† ƒë·ªìng bi·∫øn, d·∫•u (-) l√† ngh·ªãch bi·∫øn.", "Gi√≥ng l√™n h√†ng $x$ ƒë·ªÉ ch·ªët kho·∫£ng.", "Khoanh ƒë√°p √°n."]; }
                else if (c.includes("ti·ªám c·∫≠n")) { title = "Ph∆∞∆°ng ph√°p: SƒÉn Ti·ªám C·∫≠n"; steps = ["T√¨m T·∫≠p x√°c ƒë·ªãnh.", "Lim v√¥ c·ª±c -> TCN.", "Lim ƒëi·ªÉm kh√¥ng x√°c ƒë·ªãnh -> TCƒê.", "Ch·ªët k√®o."]; }
                else if (c.includes("c·ª±c tr·ªã") || c.includes("c·ª±c ƒë·∫°i") || c.includes("c·ª±c ti·ªÉu")) { title = "Ph∆∞∆°ng ph√°p: B·∫Øt C·ª±c Tr·ªã"; steps = ["ƒê·∫°o h√†m $y'$.", "T√¨m nghi·ªám $y'=0$.", "V·∫Ω b·∫£ng bi·∫øn thi√™n.", "Nh√¨n s·ª± ƒë·ªïi d·∫•u ƒë·ªÉ k·∫øt lu·∫≠n."]; }
                else if (c.includes("th·ªÉ t√≠ch")) { title = "Ph∆∞∆°ng ph√°p: T√≠nh Th·ªÉ T√≠ch"; steps = ["T√¨m chi·ªÅu cao $h$.", "T√≠nh di·ªán t√≠ch ƒë√°y $B$.", "·ªêp c√¥ng th·ª©c.", "B·∫•m m√°y."]; }
                else { steps = ["T√≥m t·∫Øt ƒë·ªÅ.", "L√¥i c√¥ng th·ª©c ra.", "L·∫≠p ph∆∞∆°ng tr√¨nh.", "Gi·∫£i v√† check l·∫°i."]; }
                return `<div class="bg-indigo-50 p-5 rounded-xl border border-indigo-200 mb-6 shadow-sm"><h4 class="font-bold text-indigo-700 mb-3 flex items-center text-base"><i class="fa-solid fa-list-ol mr-2"></i> ${title}</h4><ul class="space-y-3">${steps.map((s, idx) => `<li class="flex items-start gap-3 bg-white p-3 rounded border border-indigo-100 shadow-sm"><span class="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-xs mt-0.5">${idx + 1}</span><span class="text-slate-700 text-sm leading-relaxed font-medium">${s}</span></li>`).join('')}</ul></div>`;
            }
        };

        app.init();
    </script>
</body>
</html>
